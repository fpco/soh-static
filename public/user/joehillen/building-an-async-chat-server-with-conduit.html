<!DOCTYPE html>
<html><head><title>Building an Async Chat Server with Conduit - School of Haskell | School of Haskell</title><meta http-equiv="x-ua-compatible" content="IE=9"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="google-site-verification" content="Rfxk2TdeMMXEXHgJ2_OO8Rt3hPbQSDao0OXQV_n6z_s" /><link href="//fonts.googleapis.com/css?family=Merriweather" rel="stylesheet" type="text/css"><link href="https://www.schoolofhaskell.com/recent-content/feed" type="application/rss+xml" rel="alternate" title="Recently published content">
<link rel="stylesheet" href="https://www.schoolofhaskell.com/static/combined/UlwEHVcM.css"><style>.social{margin-right:1em}h1{font-family:Merriweather !important}article{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}h1,h2,h3,h4,h4,h5{font-family:Merriweather !important}.editor p{font-family:Frutiger, "Frutiger Linotype", Univers, Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans Condensed", "Liberation Sans", "Nimbus Sans L", Tahoma, Geneva, "Helvetica Neue", Helvetica, Arial, sans-serif}.article-footer{border-top:1px solid #ddd;padding-top:1em;margin-top:1em}body{font-size:16px !important}.navbar .navbar-inner{background:#3c3f41}.navbar .brand{font-size:14px}.navbar .brand img{width:6em}.navbar .icon-wrench{margin:0 -0.5em 0 -0.5em;padding:0 1em 0 1em;height:20px}.navbar-inverse .nav .active a{background:#333638}.navbar-inverse .nav > li > a{color:#a7a7a7
}.navbar-inverse .btn-navbar{background:#333638}.navbar-inverse .nav > li a:hover,.navbar-inverse .btn{background:#333537 !important}@media (max-width: 979px) {.icon-wrench{padding-left:1em !important}}.breadcrumb{border-top-left-radius:0;border-top-right-radius:0}h1{margin-top:20px}.breadcrumb-container + .main-content h1{margin-top:0}.footer{padding:30px 0;margin-top:70px;border-top:1px solid #e5e5e5;background-color:#f5f5f5}.footer ul.footer-menu{list-style-type:none}.footer ul.footer-menu li{display:inline-block}.footer ul.footer-menu li + li{margin-left:0.5em}.footer ul.footer-menu li + li:before{margin-right:0.5em;content:"Â·";color:#999}.footer ul.menu li{display:inline-block}.footer ul.menu li + li{margin-left:0.5em}.footer .copyright{margin-left:25px}.main-content{min-height:100%}.gravatar{width:80px;height:80px;border-radius:2px;background:#eee}.empty-gravatar{width:0}.container{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}.container h1,.container h2,.container h4,.container h4,.container h5{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}article{font-family:Merriweather !important}article h1{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}article li + li{margin-top:0.5em}article div.code{background:#f9f9f9;border:1px solid #d1d1d1;position:relative;border-radius:0.2em;margin:0.25em 0 0.75em 0;min-height:2.5em}article code{color:#005580;font-size:14px;white-space:pre}article a.hoogle > code{color:#0088cc;font-size:14px;white-space:pre;border:0}article .expand-code{display:none}article pre{overflow:auto;word-wrap:normal}article code.active{display:block;max-height:430px}article h1{font-size:31.5px}article h3{font-size:17.5px}article h4{font-size:14px}article h5,article h6{font-size:11.9px}article p{line-height:1.7em}article h1 code,article h2 code,article h3 code,article h4 code,article h5 code,article h6 code{font-size:inherit !important}article h1 a,article h2 a,article h3 a,article h4 a,article h5 a,article h6 a{color:#444}article h1 a:before,article h2 a:before,article h3 a:before,article h4 a:before,article h5 a:before,article h6 a:before{margin-left:-1.5em;padding-right:0.5em;font-family:fontawesome;content:"\f0c1";font-size:20px;color:#fff}article h1 a:hover,article h2 a:hover,article h3 a:hover,article h4 a:hover,article h5 a:hover,article h6 a:hover{text-decoration:none;color:#0088cc}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#888}article h2{font-size:24.5px}article .popover{font-family:actor}article .popover h3.popover-title{font-family:actor !important;font-size:1em}article .popover .popover-content{width:15em;font-size:1em}article .controlsRun{display:block;padding:0.5em;text-align:right;background:#f2f2f2}article .controlsRun a.clone{margin-right:1em;font-family:actor;text-decoration:none}article .controlsRun a.clone span{padding-left:0.5em}article .controlsRun a.run,article .controlsRun a.reset,article .controlsRun a.show-code{font-size:16px}article .controlsRun a.run span,article .controlsRun a.reset span,article .controlsRun a.show-code span{display:none}article .controlsRun a.reset{margin-left:0.5em;color:#a2becc}article .controlsRun a.reset{display:none}article .controlsRun a.show-code{margin-right:0.75em}article .controlsRun a.run:hover,article .controlsRun a.show-code:hover{text-decoration:none}article .controlsRun a.show-code.active{color:#DC0D0D}article .controlsRun a[disabled]{color:#a2becc;cursor:default}article .collapse-area .collapse-header{background:#0088cc;color:#fff;padding:0.3em;cursor:pointer}article .collapse-area .hidden-toggle:before{content:"\f0d7";font-family:fontawesome;margin-right:0.5em;margin-left:0.25em}article .collapse-area .collapsed-files{overflow:auto;height:auto}article .collapse-area.collapse-disabled{display:none}article .collapse-area.collapse-area-off .collapsed-files{height:0px;overflow:hidden}article .collapse-area.collapse-area-off .hidden-toggle:before{content:"\f0da"}article .snippet-stdio .stdout{margin:0.5em;padding-right:2em;position:relative;word-wrap:break-word}article .snippet-stdio .stdin{-webkit-box-shadow:none;-moz-box-shadow:none;box-shadow:none;-webkit-transition:none;-moz-transition:none;-o-transition:none;transition:none;padding:0;margin:0}article .hoogle-results{margin:0.25em}article .hoogle-results .hoogle-inner{background:#fff;padding:0.5em;border-radius:3px;border:1px solid #ddd}article .hoogle-results .hoogle-inner .close-link{position:relative;float:right;margin-top:-0.5em;margin-right:-0.5em}article .snippet-output-errors{margin:1em 0.5em 0.5em 0.5em;position:relative}article .snippet-output-errors ul{list-style-type:none;margin:0;position:relative}article .snippet-output-errors pre{border:0;border-radius:0;padding:0.25em;margin:0;background:inherit;color:inherit}article .snippet-output-errors .close-link{color:inherit;background:inherit}article .snippet-editors{z-index:0;padding:0.25em}article .close-link{padding:0.5em;background:#eaeaea;border-bottom-left-radius:0.2em;border-top-right-radius:0.2em;position:absolute;top:0;right:0}article .close-link:hover{text-decoration:none}article .snippet-title{padding:0.5em 0 0 0.5em}article .snippet-title .snippet-icon{font-family:FontAwesome;display:inline-block;margin-right:0.5em}article .fullModuleCode + div .snippet-title{margin-top:0.5em;border-top:1px solid #ccc;padding-top:0.5em}article .CodeMirror{height:auto;min-height:1em;line-height:1.5em;background:transparent;font-size:14px !important}article .CodeMirror .highlighted{background:rgba(250, 210, 0, 0.45) !important}article .CodeMirror-widget{margin-left:2em;line-height:1.8}article .CodeMirror.collapsed{height:10em !important}article .editor .expander{text-align:center;display:block;padding:0.5em;text-decoration:none;border-bottom-left-radius:2px;border-bottom-right-radius:2px}article .editor .expander .ellipsis{background:white;border:1px solid #ccc;padding:0 0.5em;height:1em;line-height:0.5em;display:inline-block;color:#555;cursor:pointer}article .editor .expander .ellipsis:hover{background:#ddd;color:#333}article .web-runner{margin:0.5em;padding:0.5em;border:1px solid #ccc;border-radius:3px;background:#f5f5f5}article .web-runner iframe{border:0;margin-top:0.5em;margin-bottom:0;background:white}article .web-runner .controls i{cursor:pointer;color:#0088cc}article .web-runner .controls i:hover{color:#222}article .web-runner .controls i + i{margin-left:0.5em}article .web-runner .controls .icon-remove{float:right}article .hidden{display:block;visibility:visible}article .controlsShowHide{margin-bottom:0.5em}.tutorial-body{float:left !important}.tutorial-nav{float:right !important}@media (max-width: 979px) {.related-content{float:right}.author-name{display:block;margin-left:20px !important;padding-left:5px;margin-top:5px}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#fff}.tutorial-nav{float:none !important;width:auto !important}.tutorial-body{float:none !important;width:auto !important}}@media (min-width: 980px) and (max-width: 1199px) {.navbar-search{display:none}.tutorial-nav{width:200px}.tutorial-body{width:720px}}#accountPage h1{margin:20px 0 0 0}#accountPage h2{font-size:20px}.group-contents .span8{float:left}.group-contents .span4{float:right}.container > .alert-block{margin-top:1em}.alert{color:#aa874a
}.social{margin-bottom:.8em;display:block}.social a{text-decoration:none}.social i{font-size:1.1em;color:#fff;padding:0.25em;border-radius:0.25em;width:1em;display:inline-block;text-align:center}.social i.icon-twitter{background:#0088cc}.social i.icon-facebook{background:#3b5998
  }.social i.icon-google-plus{background:#dd4b39
  }.well pre{background:#fcfcfc}.well h2{margin-top:0}code{color:#005580;font-size:14px;white-space:pre}</style><!--[if lt IE 8]><link rel="stylesheet" href="https://www.schoolofhaskell.com/static/design/css/ie7.css?etag=TSMl9x1V"><![endif]--><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head><body class="not-logged-in" itemscope itemtype="http://schema.org/Product"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-H62P" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-H62P');</script><div class="navbar navbar-inverse navbar-static-top"><div class="navbar-inner"><div class="container"><a class="btn btn-navbar" type="button" data-toggle="collapse" data-target=".nav-collapse"><span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</a>
<a class="brand" href="/"><img src="/static/img/haskell-logo-wide.png" title="School of Haskell">
</a>
<div class="nav-collapse collapse"><ul class="nav"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>
</ul>
<form class="navbar-search pull-left" action="https://www.schoolofhaskell.com/search"><input class="search-query" type="text" placeholder="Search" name="search">
</form>
</div>
</div>
</div>
</div>
<div class="container breadcrumb-container"><div class="row"><div class="span12"><ul class="breadcrumb"><li><a href="https://www.schoolofhaskell.com/user/joehillen">Joe Hillenbrand</a>
<span class="divider">/</span>
</li>
<li><a href="https://www.schoolofhaskell.com/user/joehillen/building-an-async-chat-server-with-conduit">Building an Async Chat Server with Conduit</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container main-content"><div class="row"><div class="span12"><h1 itemprop="name">Building an Async Chat Server with Conduit</h1>
</div>
</div>
<div class="row"><div class="span7 meta"><p><span class="date">17 Jun 2014</span>
<span class="author"><a href="https://www.schoolofhaskell.com/user/joehillen">Joe Hillenbrand</a>
</span>
<span class="view-edit-link pull-right"><a class="view-source-link" href="https://www.schoolofhaskell.com/tutorial-raw/1760/9e661ba5551a12d71c660dd272c95ad2270076be">View Markdown source</a>
</span>
</p>
<p class="tags"></p>
</div>
</div>
<div class="row"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
<p class="alert">As of March 2020, School of Haskell has been switched to read-only mode.</p>
<div class="row" itemprop="desc"><div class="span4 tutorial-nav"><div class="related-content"><ul class="nav nav-tabs nav-stacked"><li><script>reddit_target='fpcomplete'</script>
<script src="https://redditstatic.s3.amazonaws.com/button/button1.js"></script>
</li>
<li><a href="https://www.schoolofhaskell.com/user/joehillen">See all content by Joe Hillenbrand</a>
</li>
</ul>

</div>
<div class="aside"><h3>Sections</h3>
<ul><li><a href="#introduction">Introduction</a></li><li><a href="#setting-up">Setting Up</a></li><li><a href="#simple-server">Simple Server</a></li><li><a href="#logging-in">Logging In</a></li><li><a href="#let-s-chat-">Let&#39;s Chat!</a></li><li><a href="#quitting">Quitting</a></li><li><a href="#conclusion">Conclusion</a></li></ul></div>
</div>
<div class="span8 tutorial-body" data-environment="ghc-7.8-stable-14.09">
<article><h1 id="introduction"><a href="#introduction">Introduction</a></h1><p>As a more advanced and practical exercise for learning
how to use the data streaming library
<a href="https://hackage.haskell.org/package/conduit">conduit</a>,
I thought I would recreate the asynchronous chat server
from Simon Marlow's book,
<a href="http://chimera.labs.oreilly.com/books/1230000000929/ch12.html#sec_chat">Parallel and Concurrent Programming in Haskell</a>.
If you haven't read it yet,
it's required reading for anyone who wants to build
performant, real-world Haskell applications.</p><p>This tutorial assumes you that already know Haskell,
and that you've read these other conduit tutorials:</p><ul><li><a href="https://www.fpcomplete.com/school/to-infinity-and-beyond/pick-of-the-week/conduit-overview">Conduit Overview</a></li><li><a href="http://www.yesodweb.com/blog/2014/03/network-conduit-async">network-conduit, async, and conduit-combinators</a></li></ul><p>Now, let's get started.</p><h1 id="setting-up"><a href="#setting-up">Setting Up</a></h1><p>The first thing we will do is set up a new cabal sandbox
and install some dependencies:</p><pre><code class="bash">mkdir conduit-chat
cd conduit-chat
cabal sandbox init
cabal install conduit conduit-combinators network-conduit</code></pre><p>I ran into a <a href="https://github.com/haskell/cabal/issues/1875">bug</a>
with cabal 1.20, so you might have to run this in order to install
conduit-combinators:</p><pre><code class="bash">cabal install conduit-combinators --constraint 'vector-instances==3.3' --max-backjumps=-1</code></pre><h1 id="simple-server"><a href="#simple-server">Simple Server</a></h1><p>Let's start with the most basic TCP server.</p><pre><code class="haskell">import           Conduit
import           Data.Conduit.Network
import qualified Data.ByteString.Char8 as BS

main :: IO ()
main = runTCPServer (serverSettings 4000 &quot;*&quot;) $ \appData -&gt;
    appSource appData $$ awaitForever $ liftIO . BS.putStr</code></pre><p>Build and run the server using:</p><pre><code class="bash">cabal exec runhaskell server.hs</code></pre><p>And connect to it using telnet:</p><pre><code class="bash">telnet 127.0.0.1 4000</code></pre><p>Not a very interesting server,
but as you might have noticed with the original async chat server
there is a lot of boilerplate when working with async and network Handles.
<a href="hackage.haskell.org/package/network-conduit">network-conduit</a> relieves most of that boilerplate.</p><h1 id="logging-in"><a href="#logging-in">Logging In</a></h1><p>The first thing we want to do is allow users to log in.</p><p>The original login function is called <code>readName</code>.
The only login requirement is a username
that doesn't conflict with other users' names.
We are going to have the same function, but we're going to use conduits.</p><p>We might want to do something like this with <code>readName</code> as a <code>Conduit</code>:</p><pre><code class="haskell">main :: IO ()
main = do
    server &lt;- newServer
    runTCPServer (serverSettings 4000 &quot;*&quot;) $ \appData -&gt;
        appSource appData $$ readName server =$ appSink appData</code></pre><p>However, we need a way to get the <code>Client</code> after <code>readName</code> finishes,
but the type of <code>appSink</code> is <code>Sink ByteString IO ()</code>.</p><p>We can use <a href="http://hackage.haskell.org/package/conduit-1.1.6/docs/Data-Conduit.html#v:fuseUpstream">fuseUpstream</a>
for this.</p><p>Here is the result:</p><pre><code class="haskell">{-# LANGUAGE OverloadedStrings, RecordWildCards, LambdaCase #-}

import           Conduit
import           Data.Conduit
import           Data.Conduit.Network
import qualified Data.ByteString.Char8 as BS
import           Text.Printf              (printf)
import           Control.Concurrent.STM
import qualified Data.Map as Map
import           Data.Word8               (_cr)
import           Control.Monad
import           Control.Concurrent.Async (concurrently)
import           Control.Exception        (finally)

type ClientName = BS.ByteString

data Client = Client
  { clientName     :: ClientName
  , clientApp      :: AppData
  }


instance Show Client where
    show client =
        BS.unpack (clientName client) ++ &quot;@&quot;
            ++ show (appSockAddr $ clientApp client)


data Server = Server {
    clients :: TVar (Map.Map ClientName Client)
}


data Message = Notice BS.ByteString
             | Tell ClientName BS.ByteString
             | Broadcast ClientName BS.ByteString
             | Command BS.ByteString
             deriving Show


newServer :: IO Server
newServer = do
  c &lt;- newTVarIO Map.empty
  return Server { clients = c }


newClient :: ClientName -&gt; AppData -&gt; STM Client
newClient name app = do
    return Client { clientName = name
                  , clientApp  = app
                  }

checkAddClient :: Server -&gt; ClientName -&gt; AppData -&gt; IO (Maybe Client)
checkAddClient server@Server{..} name app = atomically $ do
    clientmap &lt;- readTVar clients
    if Map.member name clientmap then
        return Nothing
    else do
        client &lt;- newClient name app
        writeTVar clients $ Map.insert name client clientmap
        return (Just client)

-- show
readName :: Server -&gt; AppData -&gt; ConduitM BS.ByteString BS.ByteString IO Client
readName server app = go
  where
  go = do
    yield &quot;What is your name? &quot; $$ appSink app
    name &lt;- lineAsciiC $ takeCE 80 =$= filterCE (/= _cr) =$= foldC
    if BS.null name then
        go
    else do
        ok &lt;- liftIO $ checkAddClient server name app
        case ok of
            Nothing -&gt; do
                respond &quot;The name '%s' is in use, please choose another\n&quot; name
                go
            Just client -&gt; do
                respond &quot;Welcome, %s!\n&quot; name
                return client
  respond msg name = yield $ BS.pack $ printf msg $ BS.unpack name


main :: IO ()
main = do
    server &lt;- newServer
    runTCPServer (serverSettings 4000 &quot;*&quot;) $ \app -&gt; do
        client &lt;-
            appSource app $$ readName server app `fuseUpstream` appSink app
        printf &quot;%s has connected&quot; $ BS.unpack $ clientName client</code></pre><h1 id="let-s-chat-"><a href="#let-s-chat-">Let's Chat!</a></h1><p>Now that we have a client connected and logged in, let's start chatting!</p><p>In the original chat server,
a client has a <code>TChan</code> to receive messages. 
We can use conduits for this.</p><p>First, install <a href="http://hackage.haskell.org/package/stm-conduit">stm-conduit</a>:</p><pre><code class="bash">cabal install stm-conduit</code></pre><p>and we will use it like this:</p><pre><code class="haskell">import           Data.Conduit.TMChan

data Client = Client
  { clientName     :: ClientName
  , clientChan     :: TMChan Message
  , clientApp      :: AppData
  }


newClient :: ClientName -&gt; AppData -&gt; STM Client
newClient name app = do
    chan &lt;- newTMChan
    return Client { clientName     = name
                  , clientApp      = app
                  , clientChan     = chan
                  }

main :: IO ()
main = do
    server &lt;- newServer
    runTCPServer (serverSettings 4000 &quot;*&quot;) $ \app -&gt; do
        (fromClient, client) &lt;-
            appSource app $$+ readName server app `fuseUpstream` appSink app
        void $ concurrently
            (fromClient $$+- linesUnboundedAsciiC =$= mapC Command =$ sinkTMChan (clientChan client) True)
            (sourceTMChan (clientChan client) $$ handleMessage server client =$ appSink app)
</code></pre><p>We must be sure to use a <code>ResumableSource</code> with <code>$$+</code> or else there could be data loss.</p><p>With this, all lines sent to the client's socket are turned into <code>Command</code>s
and written to the client's <code>TMChan</code>.
Concurrently, <code>Message</code>s sent to the client's <code>TMChan</code> are processed by
the conduit <code>handleMessage</code>.</p><p>This is very similar to the original <code>handleMessage</code>
but with two simple changes.</p><p>First, instead of <code>readTVar</code> at the beginning of the message handling loop,
we will use <code>awaitForever</code>. 
Second, instead of <code>output</code> writing to a socket <code>Handle</code>,
we write to the client's <code>Sink</code> using <code>yield</code>.</p><p>Thus <code>output</code> becomes:</p><pre><code class="haskell">output s = yield $ s `BS.append` &quot;\n&quot;</code></pre><p>Here is the result:</p><pre><code class="haskell">sendMessage :: Client -&gt; Message -&gt; STM ()
sendMessage Client{..} msg = writeTMChan clientChan msg

sendToName :: Server -&gt; ClientName -&gt; Message -&gt; STM Bool
sendToName server@Server{..} name msg = do
    clientmap &lt;- readTVar clients
    case Map.lookup name clientmap of
        Nothing -&gt; return False
        Just client -&gt; sendMessage client msg &gt;&gt; return True

(&lt;++&gt;) = BS.append

handleMessage :: Server -&gt; Client -&gt; Conduit Message IO BS.ByteString
handleMessage server client@Client{..} = awaitForever $ \case
    Notice msg         -&gt; output $ &quot;*** &quot; &lt;++&gt; msg
    Tell name msg      -&gt; output $ &quot;*&quot; &lt;++&gt; name &lt;++&gt; &quot;*: &quot; &lt;++&gt; msg
    Broadcast name msg -&gt; output $ &quot;&lt;&quot; &lt;++&gt; name &lt;++&gt; &quot;&gt;: &quot; &lt;++&gt; msg
    Command msg        -&gt; case BS.words msg of
        [&quot;/tell&quot;, who, what] -&gt; do
            ok &lt;- liftIO $ atomically $
                sendToName server who $ Tell clientName what
            unless ok $ output $ who &lt;++&gt; &quot; is not connected.&quot;

        -- ignore empty strings
        [&quot;&quot;] -&gt; return ()
        [] -&gt; return ()

        -- broadcasts
        ws -&gt;
            if BS.head (head ws) == '/' then
                output $ &quot;Unrecognized command: &quot; &lt;++&gt; msg
            else
                liftIO $ atomically $
                    broadcast server $ Broadcast clientName msg
  where
    output s = yield $ s &lt;++&gt; &quot;\n&quot;</code></pre><p>Most other functions are just about the same as the original.
Once you put it all together, you should have a working chat server.</p><h1 id="quitting"><a href="#quitting">Quitting</a></h1><p>One last feature we haven't implemented yet is quitting.
There are multiple ways a user can quit.
First is using the '/quit' command.
Another might be to just drop the TCP connection.</p><p>There are several ways to implement this,
but it seems the simplest method would be to raise an exception
to exit out of the conduits
and then notify the other users in the exception handler.</p><p>Let's do it!</p><p>First we will copy over the <code>removeClient</code>
from the original async chat server (with a minor change):</p><pre><code class="haskell">removeClient :: Server -&gt; Client -&gt; IO ()
removeClient server@Server{..} client@Client{..} = atomically $ do
    modifyTVar' clients $ Map.delete clientName
    broadcast server $ Notice (clientName &lt;++&gt; &quot; has disconnected&quot;)</code></pre><p>Next we will use it in <code>main</code>
(The conduits have been moved to a separate function called <code>runClient</code>):</p><pre><code class="haskell">runClient :: ResumableSource IO BS.ByteString -&gt; Server -&gt; Client -&gt; IO ()
runClient clientSource server client@Client{..} =
    void $ concurrently
        (clientSource $$+- linesUnboundedAsciiC =$ clientSink client)
        (sourceTMChan clientChan $$ handleMessage server client =$ appSink clientApp)

removeClient :: Server -&gt; Client -&gt; IO ()
removeClient server@Server{..} client@Client{..} = atomically $ do
    modifyTVar' clients $ Map.delete clientName
    broadcast server $ Notice (clientName &lt;++&gt; &quot; has disconnected&quot;)

-- show
main :: IO ()
main = do
    server &lt;- newServer
    runTCPServer (serverSettings 4000 &quot;*&quot;) $ \app -&gt; do
        (fromClient, client) &lt;-
            appSource app $$+ readName server app =$ appSink app
        (runClient fromClient server client)
            `finally` (removeClient server client)</code></pre><p>Lastly, we implement the '/quit' command:</p><pre><code class="haskell">handleMessage :: Server -&gt; Client -&gt; Conduit Message IO BS.ByteString
handleMessage server client@Client{..} = awaitForever $ \case
    Notice msg -&gt; output $ &quot;*** &quot; &lt;++&gt; msg
    Tell name msg      -&gt; output $ &quot;*&quot; &lt;++&gt; name &lt;++&gt; &quot;*: &quot; &lt;++&gt; msg
    Broadcast name msg -&gt; output $ &quot;&lt;&quot; &lt;++&gt; name &lt;++&gt; &quot;&gt;: &quot; &lt;++&gt; msg
    Command msg        -&gt; case BS.words msg of
        [&quot;/tell&quot;, who, what] -&gt; do
            ok &lt;- liftIO $ atomically $
                sendToName server who $ Tell clientName what
            unless ok $ output $ who &lt;++&gt; &quot; is not connected.&quot;

-- show
        [&quot;/quit&quot;] -&gt; do
            error . BS.unpack $ clientName &lt;++&gt; &quot; has quit&quot;
-- /show

        -- ignore empty strings
        [&quot;&quot;] -&gt; return ()
        [] -&gt; return ()

        -- broadcasts
        ws -&gt;
            if BS.head (head ws) == '/' then
                output $ &quot;Unrecognized command: &quot; &lt;++&gt; msg
            else
                liftIO $ atomically $
                    broadcast server $ Broadcast clientName msg
  where
    output s = yield $ s &lt;++&gt; &quot;\n&quot;</code></pre><h1 id="conclusion"><a href="#conclusion">Conclusion</a></h1><p><a href="https://gist.github.com/joehillen/b6cc59285d50fd67c120">Here is the whole server put together.</a></p><p>There are many more features that could be added,
like more commands (such as '/kick', '/list', and '/help')
or support for rooms,
but those are exercises for the reader.</p><p>If you are looking for more conduit practice, 
then I recommend implementing a better chat client than telnet.</p><p>I hope this has helped you understand conduits in a more applied way.</p><p>Happy Hacking!</p></article>


</div>
</div>
<div class="row article-footer"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
</div>
<div class="footer"><div class="container"><div class="row"><div class="span12"><ul class="menu"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>

<li><a class="brand" href="https://fpcomplete.com">Sponsored by:
<img src="/static/img/logo.png" title="FPComplete">
</a>
</li>
</ul>
</div>
</div>
<div class="row"><div class="span12"></div>
</div>
</div>
</div>
<link rel="stylesheet" type="text/css" href="/static/bootstrap/css/bootstrap-responsive.css" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://www.schoolofhaskell.com/static/combined/Y-3k9_tW.js"></script><script>$(function(){
  $("a.logout").click(function(){
    var form = $("<form method='post'/>");
    form.attr("action", $(this).attr("href"));
    $("body").append(form);
    form.submit();
    return false;
  });
});

$(function(){
    $('.sociallinksunicode a').each(function(){
        $(this).attr('href',$(this).attr('href').replace('$url$',document.location));
    });
});

$(function(){
  // If we need to select a user/select a password then show the
  // details confirmation form, otherwise enable the getting started
  // section.
  if($('.alert-block a').text().match(/(selected a username|change your password)/)) {
    $("#confirm-details").show();
    $("#confirm-details #inputUsername").focus();
  } else {
    $("#get-started").removeClass('disabled').addClass('enabled');
  }

  // For lack of a plain HTML validation story this will do.
  $('.welcome-page').each(function(){
    $('form').submit(check);
  });
  function check(){
    setTimeout(check,500);
    var error = false;
    $('.error').removeClass('error');
    $('#enter-details input').each(function(){
      if($(this).val() == '') {
        $(this).parent().parent().addClass('error');
        error = true;
      }
    });
    if(error) return false;
    if($('[name=password]').val() == $('[name=confirm]').val()) {
      $('#confirm').removeClass('error');
      return true;
    } else {
      $('#confirm').addClass('error');
      return false;
    }
  }
});

$(function(){
  // When scrolling over a snippet editor, activate the "clone in IDE" popovers
  $('article').each(function(){
    var n = 100;
    var wait = 10000;
    function check(){
      if($('.clone').length == 0) {
        setTimeout(check,n);
        return;
      }
      var activated = $.cookie('clone-popover');
      if (activated) return;
      var activate = false;
      $('.controlsRun:onScreen').each(function(){
        $.cookie('clone-popover', 'true', { expires: 30, path: '/' });
        activate = true;
        return false;
      });
      if(activate) {
          $('.clone').each(function(){
              // The bootstrap API is rather unreasonable to say the
              // least.
              next = $(this).parent();
              var title = next.attr('title');
              next.attr('data-content',$(this).attr('data-content'));
              next.attr('title',$(this).attr('title'));
              next.popover('show',{
                  title: $(this).attr('title')
              });
              next.attr('title',title);
          });
          setTimeout(function(){
              $('.clone').each(function(){
                  $(this).parent().popover('hide');
              });
          },wait);
      } else {
        setTimeout(check,n);
      }
    }
    setTimeout(check,n);
  });
});

// onScreen jQuery plugin v0.2.1
// (c) 2011-2013 Ben Pickles
//
// http://benpickles.github.com/onScreen
//
// Released under MIT license.
(function(a){a.expr[":"].onScreen=function(b){var c=a(window),d=c.scrollTop(),e=c.height(),f=d+e,g=a(b),h=g.offset().top,i=g.height(),j=h+i;return h>=d&&h<f||j>d&&j<=f||i>e&&h<=d&&j>=f}})(jQuery);

/*!
 * jQuery Cookie Plugin v1.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function($, document) {

  var pluses = /\+/g;
  function raw(s) {
    return s;
  }
  function decoded(s) {
    return decodeURIComponent(s.replace(pluses, ' '));
  }

  $.cookie = function(key, value, options) {

    // key and at least value given, set cookie...
    if (arguments.length > 1 && (!/Object/.test(Object.prototype.toString.call(value)) || value == null)) {
      options = $.extend({}, $.cookie.defaults, options);

      if (value == null) {
	options.expires = -1;
      }

      if (typeof options.expires === 'number') {
	var days = options.expires, t = options.expires = new Date();
	t.setDate(t.getDate() + days);
      }

      value = String(value);

      return (document.cookie = [
	encodeURIComponent(key), '=', options.raw ? value : encodeURIComponent(value),
	options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
	options.path    ? '; path=' + options.path : '',
	options.domain  ? '; domain=' + options.domain : '',
	options.secure  ? '; secure' : ''
      ].join(''));
    }

    // key and possibly options given, get cookie...
    options = value || $.cookie.defaults || {};
    var decode = options.raw ? raw : decoded;
    var cookies = document.cookie.split('; ');
    for (var i = 0, parts; (parts = cookies[i] && cookies[i].split('=')); i++) {
      if (decode(parts.shift()) === key) {
	return decode(parts.join('='));
      }
    }
    return null;
  };
  $.cookie.defaults = {};})(jQuery, document);
</script><!--[if lt IE 10]><script src="https://www.schoolofhaskell.com/static/design/js/ie.js?etag=ayV2DuJ0"></script><![endif]--><script>if(!window.location.href.match(/localhost/)){var track = '/tutorial/user/joehillen/building-an-async-chat-server-with-conduit';
window._gaq = [['_setAccount','UA-36928035-1'],track != ''? ['_trackPageview',track] : ['_trackPageview']
,['_trackPageLoadTime']];window._gaq.push(['_setCustomVar',1,'Section','School of Haskell',3]);
window._gaq.push(['_setCustomVar',2,'User Type','Visitor',1]);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);

})();}</script>
<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.  chromium.org/developers/how-tos/chrome-frame-getting-started --><!--[if lt IE 7 ]><script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script><script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script><![endif]--></body></html>