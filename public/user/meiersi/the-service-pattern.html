<!DOCTYPE html>
<html><head><title>The Service Pattern - School of Haskell | School of Haskell</title><meta http-equiv="x-ua-compatible" content="IE=9"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="google-site-verification" content="Rfxk2TdeMMXEXHgJ2_OO8Rt3hPbQSDao0OXQV_n6z_s" /><link href="//fonts.googleapis.com/css?family=Merriweather" rel="stylesheet" type="text/css"><link href="https://www.schoolofhaskell.com/recent-content/feed" type="application/rss+xml" rel="alternate" title="Recently published content">
<link rel="stylesheet" href="https://www.schoolofhaskell.com/static/combined/UlwEHVcM.css"><style>.social{margin-right:1em}h1{font-family:Merriweather !important}article{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}h1,h2,h3,h4,h4,h5{font-family:Merriweather !important}.editor p{font-family:Frutiger, "Frutiger Linotype", Univers, Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans Condensed", "Liberation Sans", "Nimbus Sans L", Tahoma, Geneva, "Helvetica Neue", Helvetica, Arial, sans-serif}.article-footer{border-top:1px solid #ddd;padding-top:1em;margin-top:1em}body{font-size:16px !important}.navbar .navbar-inner{background:#3c3f41}.navbar .brand{font-size:14px}.navbar .brand img{width:6em}.navbar .icon-wrench{margin:0 -0.5em 0 -0.5em;padding:0 1em 0 1em;height:20px}.navbar-inverse .nav .active a{background:#333638}.navbar-inverse .nav > li > a{color:#a7a7a7
}.navbar-inverse .btn-navbar{background:#333638}.navbar-inverse .nav > li a:hover,.navbar-inverse .btn{background:#333537 !important}@media (max-width: 979px) {.icon-wrench{padding-left:1em !important}}.breadcrumb{border-top-left-radius:0;border-top-right-radius:0}h1{margin-top:20px}.breadcrumb-container + .main-content h1{margin-top:0}.footer{padding:30px 0;margin-top:70px;border-top:1px solid #e5e5e5;background-color:#f5f5f5}.footer ul.footer-menu{list-style-type:none}.footer ul.footer-menu li{display:inline-block}.footer ul.footer-menu li + li{margin-left:0.5em}.footer ul.footer-menu li + li:before{margin-right:0.5em;content:"Â·";color:#999}.footer ul.menu li{display:inline-block}.footer ul.menu li + li{margin-left:0.5em}.footer .copyright{margin-left:25px}.main-content{min-height:100%}.gravatar{width:80px;height:80px;border-radius:2px;background:#eee}.empty-gravatar{width:0}.container{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}.container h1,.container h2,.container h4,.container h4,.container h5{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}article{font-family:Merriweather !important}article h1{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}article li + li{margin-top:0.5em}article div.code{background:#f9f9f9;border:1px solid #d1d1d1;position:relative;border-radius:0.2em;margin:0.25em 0 0.75em 0;min-height:2.5em}article code{color:#005580;font-size:14px;white-space:pre}article a.hoogle > code{color:#0088cc;font-size:14px;white-space:pre;border:0}article .expand-code{display:none}article pre{overflow:auto;word-wrap:normal}article code.active{display:block;max-height:430px}article h1{font-size:31.5px}article h3{font-size:17.5px}article h4{font-size:14px}article h5,article h6{font-size:11.9px}article p{line-height:1.7em}article h1 code,article h2 code,article h3 code,article h4 code,article h5 code,article h6 code{font-size:inherit !important}article h1 a,article h2 a,article h3 a,article h4 a,article h5 a,article h6 a{color:#444}article h1 a:before,article h2 a:before,article h3 a:before,article h4 a:before,article h5 a:before,article h6 a:before{margin-left:-1.5em;padding-right:0.5em;font-family:fontawesome;content:"\f0c1";font-size:20px;color:#fff}article h1 a:hover,article h2 a:hover,article h3 a:hover,article h4 a:hover,article h5 a:hover,article h6 a:hover{text-decoration:none;color:#0088cc}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#888}article h2{font-size:24.5px}article .popover{font-family:actor}article .popover h3.popover-title{font-family:actor !important;font-size:1em}article .popover .popover-content{width:15em;font-size:1em}article .controlsRun{display:block;padding:0.5em;text-align:right;background:#f2f2f2}article .controlsRun a.clone{margin-right:1em;font-family:actor;text-decoration:none}article .controlsRun a.clone span{padding-left:0.5em}article .controlsRun a.run,article .controlsRun a.reset,article .controlsRun a.show-code{font-size:16px}article .controlsRun a.run span,article .controlsRun a.reset span,article .controlsRun a.show-code span{display:none}article .controlsRun a.reset{margin-left:0.5em;color:#a2becc}article .controlsRun a.reset{display:none}article .controlsRun a.show-code{margin-right:0.75em}article .controlsRun a.run:hover,article .controlsRun a.show-code:hover{text-decoration:none}article .controlsRun a.show-code.active{color:#DC0D0D}article .controlsRun a[disabled]{color:#a2becc;cursor:default}article .collapse-area .collapse-header{background:#0088cc;color:#fff;padding:0.3em;cursor:pointer}article .collapse-area .hidden-toggle:before{content:"\f0d7";font-family:fontawesome;margin-right:0.5em;margin-left:0.25em}article .collapse-area .collapsed-files{overflow:auto;height:auto}article .collapse-area.collapse-disabled{display:none}article .collapse-area.collapse-area-off .collapsed-files{height:0px;overflow:hidden}article .collapse-area.collapse-area-off .hidden-toggle:before{content:"\f0da"}article .snippet-stdio .stdout{margin:0.5em;padding-right:2em;position:relative;word-wrap:break-word}article .snippet-stdio .stdin{-webkit-box-shadow:none;-moz-box-shadow:none;box-shadow:none;-webkit-transition:none;-moz-transition:none;-o-transition:none;transition:none;padding:0;margin:0}article .hoogle-results{margin:0.25em}article .hoogle-results .hoogle-inner{background:#fff;padding:0.5em;border-radius:3px;border:1px solid #ddd}article .hoogle-results .hoogle-inner .close-link{position:relative;float:right;margin-top:-0.5em;margin-right:-0.5em}article .snippet-output-errors{margin:1em 0.5em 0.5em 0.5em;position:relative}article .snippet-output-errors ul{list-style-type:none;margin:0;position:relative}article .snippet-output-errors pre{border:0;border-radius:0;padding:0.25em;margin:0;background:inherit;color:inherit}article .snippet-output-errors .close-link{color:inherit;background:inherit}article .snippet-editors{z-index:0;padding:0.25em}article .close-link{padding:0.5em;background:#eaeaea;border-bottom-left-radius:0.2em;border-top-right-radius:0.2em;position:absolute;top:0;right:0}article .close-link:hover{text-decoration:none}article .snippet-title{padding:0.5em 0 0 0.5em}article .snippet-title .snippet-icon{font-family:FontAwesome;display:inline-block;margin-right:0.5em}article .fullModuleCode + div .snippet-title{margin-top:0.5em;border-top:1px solid #ccc;padding-top:0.5em}article .CodeMirror{height:auto;min-height:1em;line-height:1.5em;background:transparent;font-size:14px !important}article .CodeMirror .highlighted{background:rgba(250, 210, 0, 0.45) !important}article .CodeMirror-widget{margin-left:2em;line-height:1.8}article .CodeMirror.collapsed{height:10em !important}article .editor .expander{text-align:center;display:block;padding:0.5em;text-decoration:none;border-bottom-left-radius:2px;border-bottom-right-radius:2px}article .editor .expander .ellipsis{background:white;border:1px solid #ccc;padding:0 0.5em;height:1em;line-height:0.5em;display:inline-block;color:#555;cursor:pointer}article .editor .expander .ellipsis:hover{background:#ddd;color:#333}article .web-runner{margin:0.5em;padding:0.5em;border:1px solid #ccc;border-radius:3px;background:#f5f5f5}article .web-runner iframe{border:0;margin-top:0.5em;margin-bottom:0;background:white}article .web-runner .controls i{cursor:pointer;color:#0088cc}article .web-runner .controls i:hover{color:#222}article .web-runner .controls i + i{margin-left:0.5em}article .web-runner .controls .icon-remove{float:right}article .hidden{display:block;visibility:visible}article .controlsShowHide{margin-bottom:0.5em}.tutorial-body{float:left !important}.tutorial-nav{float:right !important}@media (max-width: 979px) {.related-content{float:right}.author-name{display:block;margin-left:20px !important;padding-left:5px;margin-top:5px}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#fff}.tutorial-nav{float:none !important;width:auto !important}.tutorial-body{float:none !important;width:auto !important}}@media (min-width: 980px) and (max-width: 1199px) {.navbar-search{display:none}.tutorial-nav{width:200px}.tutorial-body{width:720px}}#accountPage h1{margin:20px 0 0 0}#accountPage h2{font-size:20px}.group-contents .span8{float:left}.group-contents .span4{float:right}.container > .alert-block{margin-top:1em}.alert{color:#aa874a
}.social{margin-bottom:.8em;display:block}.social a{text-decoration:none}.social i{font-size:1.1em;color:#fff;padding:0.25em;border-radius:0.25em;width:1em;display:inline-block;text-align:center}.social i.icon-twitter{background:#0088cc}.social i.icon-facebook{background:#3b5998
  }.social i.icon-google-plus{background:#dd4b39
  }.well pre{background:#fcfcfc}.well h2{margin-top:0}code{color:#005580;font-size:14px;white-space:pre}</style><!--[if lt IE 8]><link rel="stylesheet" href="https://www.schoolofhaskell.com/static/design/css/ie7.css?etag=TSMl9x1V"><![endif]--><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head><body class="not-logged-in" itemscope itemtype="http://schema.org/Product"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-H62P" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-H62P');</script><div class="navbar navbar-inverse navbar-static-top"><div class="navbar-inner"><div class="container"><a class="btn btn-navbar" type="button" data-toggle="collapse" data-target=".nav-collapse"><span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</a>
<a class="brand" href="/"><img src="/static/img/haskell-logo-wide.png" title="School of Haskell">
</a>
<div class="nav-collapse collapse"><ul class="nav"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>
</ul>
<form class="navbar-search pull-left" action="https://www.schoolofhaskell.com/search"><input class="search-query" type="text" placeholder="Search" name="search">
</form>
</div>
</div>
</div>
</div>
<div class="container breadcrumb-container"><div class="row"><div class="span12"><ul class="breadcrumb"><li><a href="https://www.schoolofhaskell.com/user/meiersi">Simon Meier</a>
<span class="divider">/</span>
</li>
<li><a href="https://www.schoolofhaskell.com/user/meiersi/the-service-pattern">The Service Pattern</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container main-content"><div class="row"><div class="span12"><h1 itemprop="name">The Service Pattern</h1>
</div>
</div>
<div class="row"><div class="span7 meta"><p><span class="date"> 3 Mar 2015</span>
<span class="author"><a href="https://www.schoolofhaskell.com/user/meiersi">Simon Meier</a>
</span>
<span class="view-edit-link pull-right"><a class="view-source-link" href="https://www.schoolofhaskell.com/tutorial-raw/17566/0b91b42c2297f283ba201c291752c3302d0e2c09">View Markdown source</a>
</span>
</p>
<p class="tags"></p>
</div>
</div>
<div class="row"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
<p class="alert">As of March 2020, School of Haskell has been switched to read-only mode.</p>
<div class="row" itemprop="desc"><div class="span4 tutorial-nav"><div class="related-content"><ul class="nav nav-tabs nav-stacked"><li><script>reddit_target='fpcomplete'</script>
<script src="https://redditstatic.s3.amazonaws.com/button/button1.js"></script>
</li>
<li><a href="https://www.schoolofhaskell.com/user/meiersi">See all content by Simon Meier</a>
</li>
</ul>

</div>
<div class="aside"><h3>Sections</h3>
<ul><li><a href="#the-service-pattern">The Service Pattern</a><ul><li><a href="#when-to-use-the-service-pattern">When to use the service pattern</a></li><li><a href="#what-is-the-service-pattern">What is the service pattern</a><ul><li><a href="#a-simple-logging-service">A simple logging service</a></li><li><a href="#formal-definition-of-the-service-pattern">Formal definition of the service pattern</a></li></ul></li><li><a href="#discussion-of-the-service-pattern">Discussion of the service pattern</a><ul><li><a href="#relying-on-just-io">Relying on just IO</a></li><li><a href="#why-not-use-type-classes-to-define-handles-">Why not use type classes to define handles?</a></li><li><a href="#how-does-this-relate-to-object-oriented-programming-">How does this relate to object-oriented programming?</a></li></ul></li><li><a href="#conclusion">Conclusion</a></li></ul></li></ul></div>
</div>
<div class="span8 tutorial-body" data-environment="def">
<article><h1 id="the-service-pattern"><a href="#the-service-pattern">The Service Pattern</a></h1><p>This tutorial describes a design pattern
  that I discovered when working at Better.
It explains how to structure
  the <code>IO</code>-layer of a Haskell application as a
  <a href="http://en.wikipedia.org/wiki/Service-oriented_architecture">Service-oriented architecture</a>.
By <code>IO</code>-layer,
  I mean the set of all functions that can execute <code>IO</code> actions.
At Better,
  we used this pattern extensively
  to modularize the <code>IO</code>-layer of our application.</p><p>Acknowledgements: thanks to Jasper Van der Jeugt for proof reading.</p><h2 id="when-to-use-the-service-pattern"><a href="#when-to-use-the-service-pattern">When to use the service pattern</a></h2><p>The service pattern allows you to modularize the use of subsystems
  that are shared between different parts of the <code>IO</code>-layer of your
  application.
Typical examples of such subsystems are
  logging and monitoring support,
  database access,
  caches,
  authentication and authorization support,
  or
  connection pools.
We found that it is easier to refer to these sub-systems as <i>services</i>,
  which is what we are going to use in the remainder of this tutorial.</p><h2 id="what-is-the-service-pattern"><a href="#what-is-the-service-pattern">What is the service pattern</a></h2><p>The service pattern defines a particular module structure for implementing
  services.
Before giving a formal definition of this structure,
  I'm going to demonstrate it on a simple example.</p><h3 id="a-simple-logging-service"><a href="#a-simple-logging-service">A simple logging service</a></h3><p>Logging is a central functionality in many applications.
It is a must for web-application servers,
  and
  it provides a principled means to implement console output at different
  verbosity levels for command-line tools.
Interestingly,
  logging is a functionality for which most applications require at least two
  different implementations.
During execution all code should log to the same file or socket
  according to the verbosity level,
    while during testing we would like each test to have its own logger
    and we would like to verify that no warnings or errors are logged.
We can achieve this polymorphicity as follows.
We first introduce an abstract interface for a logger.</p><pre><code class="haskell">-- | This is an abstract interface for a simple logger. It is intended to be
-- imported qualified as follows.
--
-- &gt; import qualified Acme.System.Logger as Logger
--
module Acme.System.Logger
  ( -- * Abstract handles
    Handle(..)

    -- * Priorities and convenience functions
  , Priority(..)
    -- | The following functions simplify logging at a fixed priority level.
  , logDebug
  , logInfo
  , logWarning
  , logError
  ) where

import qualified Data.Text as T

data Priority
    = Debug    -- ^ Debug messages
    | Info     -- ^ Notable information that requires no immediate action.
    | Warning  -- ^ Something is probably wrong, and we should investigate.
    | Error    -- ^ Something is wrong and immediate action is required.
    deriving (Eq, Ord, Show)

newtype Handle = Handle
    { log :: Priority -&gt; T.Text -&gt; IO () }

logDebug, logInfo, logWarning, logError :: Handle -&gt; T.Text -&gt; IO ()
logDebug   = (`log` Debug)
logInfo    = (`log` Info)
logWarning = (`log` Warning)
logError   = (`log` Error)</code></pre><p>Functions that require access to logging can now be written against this
  abstract interface.
For example,
  a naive web-crawler could have the signature.</p><pre><code class="haskell">import qualified Acme.System.Logger as Logger

collectLinksBelow :: Logger.Handle -&gt; T.Text -&gt; IO [T.Text]</code></pre><p>We can write concrete implementations of this logger are as follows.</p><pre><code class="haskell">-- | A logger implementation that logs all messages to a 'System.IO.Handle'.
module Acme.System.Logger.Impl.FileHandle
  ( newHandle
  ) where

import qualified Acme.System.Logger      as Logger
import           Data.Monoid             (&lt;&gt;)
import           Control.Concurrent.MVar (newMVar, withMVar)
import qualified System.IO

-- | Create a new 'Logger.Handle' that logs to a 'System.IO.Handle'.
newHandle :: System.IO.Handle -&gt; IO Logger.Handle
newHandle fileH = do
    -- We use a mutex to make our logger thread-safe.
    -- (Note that we should take this mutex as an argument for maximal
    -- compositionality.)
    mutex &lt;- newMVar ()

    return $ Logger.Handle
      { Logger.log = \prio msg -&gt;
            withMVar mutex $ \() -&gt;
                hPutStrLn fileH $ show prio &lt;&gt; &quot;: &quot; &lt;&gt; T.unpack msg
      }</code></pre><pre><code class="haskell">-- | A logger implementation that stores all messages in an `IORef` for latter
-- inspection by a test-harness.
module Acme.System.Logger.Impl.Pure
  ( withHandle
  ) where

import qualified Acme.System.Logger as Logger

import           Data.IORef (newIORef, atomicModifyIORef, readIORef)


-- | Create a 'Logger.Handle' records all messages and returns them once the
-- inner 'IO' action terminates.
withHandle :: (Logger.Handle -&gt; IO a) -&gt; (a, [(Priority, T.Text)])
withHandle io = do
    -- We use a shared 'IORef' to records all log messages in reverse order.
    msgsRef &lt;- newIORef []
    -- Call inner IO action
    x &lt;- io $ Handle
      { Logger.log = \prio msg -&gt;
            -- We don't need the strict variant here, as we are just
            -- accumulating constructors.
            atomicModifyIORef msgsRef $ \msgs -&gt; ((prio, msg) : msgs, ())
      }
    -- return the logged messages
    msgs &lt;- readIORef msgsRef
    return (x, reverse msgs)</code></pre><h3 id="formal-definition-of-the-service-pattern"><a href="#formal-definition-of-the-service-pattern">Formal definition of the service pattern</a></h3><p>The service pattern is built around the two concepts of
  service specifications and service implementations.
A <i>service specification</i> for a service <code>X</code> is a module of the following form.</p><pre><code class="haskell">-- | Specification of the X service. This module is intended to be imported
-- qualified as follows.
--
-- &gt; import qualified YourModulePrefix.X as X
--
module YourModulePrefix.X
  (
    -- * Abstract handle
    Handle(..)

    -- * Pure types
    -- Here you export types that are necessary to interact with service X,
    -- but are too specific to fit into their own module, e.g., the priorities
    -- above in the logger service.

    -- * Derived functions
    -- Here you export derived functions that work for any implementation of
    -- service X.
    -- They are typically of the shape `fun :: Handle -&gt; params -&gt; IO result`

  ) where

data Handle = Handle
    { function1 :: !(param1_1 -&gt; ... -&gt; param1_N1 -&gt; IO result1)
      ...
    , functionM :: !(paramM_1 -&gt; ... -&gt; paramM_NM -&gt; IO resultM)
    }</code></pre><p>Note that this is analogous to manually constructing type-class
  dictionaries.
See the Section &quot;Discussion of the service pattern&quot;
  for a discussion on why we
  prefer this formulation to one based on type-classes.</p><p>A <i>service implementation</i> for a service <code>X</code>
  is a module of the following form.</p><pre><code class="haskell">-- | Implementation of the X service that uses ...
module YourModulePrefix.X.Impl.DescriptiveImplName
  ( Config(..)
  , withHandle
  ) where

-- Import specifications for services that we require for this implementation.
import qualified YourModulePrefix.Service1 as Service1
...
import qualified YourModulePrefix.ServiceN as ServiceN

-- Import specification that we are implementing.
import qualified YourModulePrefix.X        as X


-- | Pure representation of the configuration of your service implementation.
-- This type provides both named parameters for the 'withHandle' function and
-- a representation that can be easily serialized or parsed from an external
-- config file.
data Config = Config
    { cParam1 :: !t1
      ...
    , cParamM :: !tM
    }
    deriving (Eq, Show)

-- | Run an 'IO' action with access to an 'X.Handle'.
withHandle
    :: Config             -- ^ Configuration
    -&gt; Service1.Handle    -- ^ Service dependency 1 (e.g. a logger)
    -&gt; ...
    -&gt; ServiceN.Handle    -- ^ Service dependency N
    -&gt; (X.Handle -&gt; IO a)
    -&gt; IO a
withHandle config reqService1H ... reqServiceNH = do
    -- allocate implementation resources (e.g., a mutex)
    -- construct 'X.Handle'
    -- run inner action while making sure that we deallocate our resources
    --   both on exceptions and normal termination

-- For complicated services it often helps to define an implementation handle
-- as follows. It might even be that you have whole module structure below
-- 'YourModulePrefix.X.Impl.DescriptiveImplName' that you use to implement
-- service 'X'.
data IHandle = IHandle
    { ihConfig        :: !Config
    , ihService1      :: !Service1.Handle
      ...
    , ihServiceN      :: !ServiceN.Handle
    , ihImplResource1 :: !t1
      ...
    , ihImplResource1 :: !tM
    }

-- | Implementation of 'X.Handle.function1'.
function1 :: IHandle -&gt; param1_1 -&gt; ... -&gt; param1_N -&gt; IO result1

-- ... remaining service function implementations ...</code></pre><p>These two definitions are quite long.
To understand the definitions,
  it helps to compare them to the logger example given earlier.
I also invite you to ponder how you could apply this pattern in your codebase.
Sadly, I cannot point to the two codebases where I used this pattern,
  as both of them are closed-source.</p><h2 id="discussion-of-the-service-pattern"><a href="#discussion-of-the-service-pattern">Discussion of the service pattern</a></h2><p>The key benefits gained from the service pattern are
  modularity and increased compositionality.
We can use this pattern to structure our application purely
  as a composition of services.
In fact the main function of the Better web-application,
  looks roughly as follows.</p><pre><code class="haskell">import Better.Http.Impl.Snap             as Http.Impl.Snap

import Better.Storage.Impl.Postgres      as Storage.Impl.Postgres

import Better.System.Monitor.Impl.Ekg    as Monitor.Impl.Ekg
import Better.System.Logger.Impl.Default as Logger.Impl.Default

-- NOTE that Postgres and LRUCache are services where we combine the
-- specification and the implementation, as we currently have only one
-- implementation. We can easily abstract later, once we need additional
-- implementations.
import Better.System.Postgres            as Postgres
import Better.System.LRUCache            as LRUCache

-- We use https://hackage.haskell.org/package/managed to avoid the
-- right-indent drift from the 'withXXX' functions.
import Control.Monad.Managed (runManaged, managed)

-- | Start the Better web-service.
main :: IO ()
main = do
    -- get name of config file from arguments
    configFile &lt;- parseArguments

    -- parse service implementation configurations from the file
    monitorC  &lt;- parseMonitorC configFile
    loggerC   &lt;- parseLoggerC  configFile
    postgresC &lt;- parsePostresC configFile
    -- ... more config parsing

    -- construct service handles and run until the process is killed
    runManged $ do
        monitorH  &lt;- managed $ Monitor.Impl.Ekg.withHandle monitorC
        loggerH   &lt;- managed $ Logger.Impl.Default.withHandle loggerC monitorH
        postgresH &lt;- managed $ Postgres.withHandle postgresC monitorH loggerH
        lruCacheH &lt;- managed $ LRUCache.withHandle lruCacheC monitorH

        -- Our storage service provides all functionality related to
        -- persistence. Its API is quite large. Our production implementation
        -- of this service uses PostgreSQL.
        storageH  &lt;- managed $ Storage.Impl.Postgres storageC lruCacheC loggerH postgresH

        -- ... more services for implementing our business logic and in the end
        -- ... our snap handlers

        snapH &lt;- managed $ Http.Impl.Snap.withHandle snapC monitorH loggerH handlers

        -- wait until the the process is killed
        forever $ threadDelay 100000</code></pre><p>Note that with the service pattern we can push all implementation decisions
  to the <code>main</code> function, i.e., the root of our dependency tree.
All service implementations themselves can be implemented completely
  independent of each other.
Moreover,
  services implementations can make all their dependencies explicit,
    which enables us to mock them appropriately during testing.
It also means that more of our code becomes platform independent,
  as we can switch dependencies easily.</p><p>In my opinion,
  there are two non-obvious design decisions in the above definition of
  the service pattern.
First,
  it does not abstract over the concrete monad, but uses <code>IO</code> pervasively.
Second,
  it does not use type-classes to specify abstract <code>Handle</code>s.
We discuss the rationale for these two decision in the following two sections.</p><h3 id="relying-on-just-io"><a href="#relying-on-just-io">Relying on just IO</a></h3><p>The main reason why the functions in a service specification just use
  <code>IO result</code> instead of custom monad stacks is that this composes better.
Monad stacks fix the order of arguments and produce friction
  at abstraction boundaries due to the necessary transformations between
  different monad stacks.
We found it to be more pleasant to just pass around the handles to the
  necessary services as parameters (possibly grouped in a record).
This way all dependencies are explicit
  and function application is all we need pass around handles.</p><p>On a related note,
  we found at Better that adding effects to <code>IO</code> is often unnecessary,
  as <code>IO</code> is powerful enough on its own.
The typical use was just a <code>MaybeT</code> or <code>EitherT</code> to track exceptions
  explicitly in the types.
On service boundaries,
  we typically translated these exceptions to a descriptive log-message and
  a simple <code>Nothing</code>.</p><p>There can be made a case for abstracting <code>Handle</code>s over the the monad used to
  compute results, i.e., as
  <code>data Handle m = Handle { fun1 :: ... -&gt; m result }</code>.
This can be useful for building pure models of an application for testing.
We found that is often sufficient to build semi-pure implementations
  that are based on hidden <code>IORef</code>s.</p><h3 id="why-not-use-type-classes-to-define-handles-"><a href="#why-not-use-type-classes-to-define-handles-">Why not use type classes to define handles?</a></h3><p>The short answer is that we do not use type classes because
  we would neither gain further functionality nor code that is easier to
  reason about.
The long answer is the following.</p><p>We see two options on how one can use type classes to manage service
  dependencies.
The first one is to attach service specifications to the monad
  in which we compute the results.
For example,
  we could define the following two type classes to model monads
  that support logging and database access.</p><pre><code class="haskell">class MonadLogger m where
    log :: Priority -&gt; T.Text -&gt; m ()

class MonadDB m  where
    runTransaction :: Transaction a -&gt; m a</code></pre><p>The service dependencies of any function are then captured by corresponding
  type class constraints, as shown in the following example.</p><pre><code class="haskell">someBusinessLogic
    :: (MonadLogger m, MonadDB m)
    =&gt; param1 -&gt; ... -&gt; paramN -&gt; m result
someBusinessLogic ... = do
    mbResult &lt;- runTransaction someTransaction
    case mbResult of
      Just result -&gt; return result
      Nothing     -&gt; do
        log Warning &quot;falling back to default&quot;
        return defaultResult</code></pre><p>The main problem that we see with this approach is that it strongly
  favors the situation where all service dependencies are satisfied by a
  single instance.
This situation is however rather seldom,
  as for example configuring using different
  loggers for different service instances is common (e.g., to set different
  verbosity levels).
One can handle this case using mtl-style transformer stacks,
  but this requires more effort compared to just passing the handles
  explicitly.
Moreover,
  the explicit handles also work in the case where we need to
  abstract over some pure functions,
  e.g., how to render a link to an HTTP API call on the backend.
In this case,
  the monad typeclasses introduce unnecessary sequencing.</p><p>The second option to use type classes is to use
  functions of the form
  <code>fun1 :: X.Handle h =&gt; h -&gt; param1 -&gt; ... -&gt; paramN -&gt; IO result</code>.
This would allow a single handle to implement multiple services.
However,
  we are not sure where this would be beneficial.
A service's dependencies should always be kept private;
  and in a service implementation we can just store the handles of service
  dependencies as fields in the implementation handle.
In general,
  we found that being explicit about dependencies simplified reasoning about
  our service implementations and did not negatively impact refactoring.</p><h3 id="how-does-this-relate-to-object-oriented-programming-"><a href="#how-does-this-relate-to-object-oriented-programming-">How does this relate to object-oriented programming?</a></h3><p>The implementation strategy used in the service pattern corresponds closely to
  how interfaces and classes work in OOP.
Our service specifications declare both an interface at the type level,
  and a value representation for the interface at runtime.</p><p>In terms of memory consumption,
  our interfaces are heavier than typical class instances in an OOP language.
We store at least one pointer to the instance-data per closure,
  whereas OOP implementations
  typically store a single pointer to the
  <a href="http://en.wikipedia.org/wiki/Virtual_method_table">virtual method table</a>
  together with the other instance-data.</p><p>In terms of call overhead,
  we pay the cost of an
  <a href="https://ghc.haskell.org/trac/ghc/wiki/Commentary/Rts/HaskellExecution/FunctionCalls#Genericapply">unknown function call</a>,
    which is probably a bit slower than a virtual method invocation in an OOP
    langauge like Java.
If this becomes a performance bottleneck,
  we will have to avoid the abstraction and specialize at compile time.
<a href="https://ghc.haskell.org/trac/ghc/wiki/Backpack">Backpack</a>
  will allow us to do this in a principled fashion without losing modularity.</p><p>Compared to OOP languages,
  our interfaces are more powerful,
    as they have a first order representation.
Their functions can be mixed and matched freely,
  and we are not constrained to explain extension via inheritance.</p><h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2><p>This tutorial documents a pattern that I found
  to apply pervasively in the codebases I worked on.
The description of the pattern is a bit long,
  but I invite you to give it a shot in your codebase.
I am looking forward to hearing how it worked out.
Happy coding :-)</p></article>


</div>
</div>
<div class="row article-footer"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
</div>
<div class="footer"><div class="container"><div class="row"><div class="span12"><ul class="menu"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>

<li><a class="brand" href="https://fpcomplete.com">Sponsored by:
<img src="/static/img/logo.png" title="FPComplete">
</a>
</li>
</ul>
</div>
</div>
<div class="row"><div class="span12"></div>
</div>
</div>
</div>
<link rel="stylesheet" type="text/css" href="/static/bootstrap/css/bootstrap-responsive.css" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://www.schoolofhaskell.com/static/combined/Y-3k9_tW.js"></script><script>$(function(){
  $("a.logout").click(function(){
    var form = $("<form method='post'/>");
    form.attr("action", $(this).attr("href"));
    $("body").append(form);
    form.submit();
    return false;
  });
});

$(function(){
    $('.sociallinksunicode a').each(function(){
        $(this).attr('href',$(this).attr('href').replace('$url$',document.location));
    });
});

$(function(){
  // If we need to select a user/select a password then show the
  // details confirmation form, otherwise enable the getting started
  // section.
  if($('.alert-block a').text().match(/(selected a username|change your password)/)) {
    $("#confirm-details").show();
    $("#confirm-details #inputUsername").focus();
  } else {
    $("#get-started").removeClass('disabled').addClass('enabled');
  }

  // For lack of a plain HTML validation story this will do.
  $('.welcome-page').each(function(){
    $('form').submit(check);
  });
  function check(){
    setTimeout(check,500);
    var error = false;
    $('.error').removeClass('error');
    $('#enter-details input').each(function(){
      if($(this).val() == '') {
        $(this).parent().parent().addClass('error');
        error = true;
      }
    });
    if(error) return false;
    if($('[name=password]').val() == $('[name=confirm]').val()) {
      $('#confirm').removeClass('error');
      return true;
    } else {
      $('#confirm').addClass('error');
      return false;
    }
  }
});

$(function(){
  // When scrolling over a snippet editor, activate the "clone in IDE" popovers
  $('article').each(function(){
    var n = 100;
    var wait = 10000;
    function check(){
      if($('.clone').length == 0) {
        setTimeout(check,n);
        return;
      }
      var activated = $.cookie('clone-popover');
      if (activated) return;
      var activate = false;
      $('.controlsRun:onScreen').each(function(){
        $.cookie('clone-popover', 'true', { expires: 30, path: '/' });
        activate = true;
        return false;
      });
      if(activate) {
          $('.clone').each(function(){
              // The bootstrap API is rather unreasonable to say the
              // least.
              next = $(this).parent();
              var title = next.attr('title');
              next.attr('data-content',$(this).attr('data-content'));
              next.attr('title',$(this).attr('title'));
              next.popover('show',{
                  title: $(this).attr('title')
              });
              next.attr('title',title);
          });
          setTimeout(function(){
              $('.clone').each(function(){
                  $(this).parent().popover('hide');
              });
          },wait);
      } else {
        setTimeout(check,n);
      }
    }
    setTimeout(check,n);
  });
});

// onScreen jQuery plugin v0.2.1
// (c) 2011-2013 Ben Pickles
//
// http://benpickles.github.com/onScreen
//
// Released under MIT license.
(function(a){a.expr[":"].onScreen=function(b){var c=a(window),d=c.scrollTop(),e=c.height(),f=d+e,g=a(b),h=g.offset().top,i=g.height(),j=h+i;return h>=d&&h<f||j>d&&j<=f||i>e&&h<=d&&j>=f}})(jQuery);

/*!
 * jQuery Cookie Plugin v1.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function($, document) {

  var pluses = /\+/g;
  function raw(s) {
    return s;
  }
  function decoded(s) {
    return decodeURIComponent(s.replace(pluses, ' '));
  }

  $.cookie = function(key, value, options) {

    // key and at least value given, set cookie...
    if (arguments.length > 1 && (!/Object/.test(Object.prototype.toString.call(value)) || value == null)) {
      options = $.extend({}, $.cookie.defaults, options);

      if (value == null) {
	options.expires = -1;
      }

      if (typeof options.expires === 'number') {
	var days = options.expires, t = options.expires = new Date();
	t.setDate(t.getDate() + days);
      }

      value = String(value);

      return (document.cookie = [
	encodeURIComponent(key), '=', options.raw ? value : encodeURIComponent(value),
	options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
	options.path    ? '; path=' + options.path : '',
	options.domain  ? '; domain=' + options.domain : '',
	options.secure  ? '; secure' : ''
      ].join(''));
    }

    // key and possibly options given, get cookie...
    options = value || $.cookie.defaults || {};
    var decode = options.raw ? raw : decoded;
    var cookies = document.cookie.split('; ');
    for (var i = 0, parts; (parts = cookies[i] && cookies[i].split('=')); i++) {
      if (decode(parts.shift()) === key) {
	return decode(parts.join('='));
      }
    }
    return null;
  };
  $.cookie.defaults = {};})(jQuery, document);
</script><!--[if lt IE 10]><script src="https://www.schoolofhaskell.com/static/design/js/ie.js?etag=ayV2DuJ0"></script><![endif]--><script>if(!window.location.href.match(/localhost/)){var track = '/tutorial/user/meiersi/the-service-pattern';
window._gaq = [['_setAccount','UA-36928035-1'],track != ''? ['_trackPageview',track] : ['_trackPageview']
,['_trackPageLoadTime']];window._gaq.push(['_setCustomVar',1,'Section','School of Haskell',3]);
window._gaq.push(['_setCustomVar',2,'User Type','Visitor',1]);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);

})();}</script>
<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.  chromium.org/developers/how-tos/chrome-frame-getting-started --><!--[if lt IE 7 ]><script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script><script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script><![endif]--></body></html>