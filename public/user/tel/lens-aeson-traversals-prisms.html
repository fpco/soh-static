<!DOCTYPE html>
<html><head><title>Lens/Aeson Traversals/Prisms - School of Haskell | School of Haskell</title><meta http-equiv="x-ua-compatible" content="IE=9"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="google-site-verification" content="Rfxk2TdeMMXEXHgJ2_OO8Rt3hPbQSDao0OXQV_n6z_s" /><link href="//fonts.googleapis.com/css?family=Merriweather" rel="stylesheet" type="text/css"><link href="https://www.schoolofhaskell.com/recent-content/feed" type="application/rss+xml" rel="alternate" title="Recently published content">
<link rel="stylesheet" href="https://www.schoolofhaskell.com/static/combined/UlwEHVcM.css"><style>.social{margin-right:1em}h1{font-family:Merriweather !important}article{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}h1,h2,h3,h4,h4,h5{font-family:Merriweather !important}.editor p{font-family:Frutiger, "Frutiger Linotype", Univers, Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans Condensed", "Liberation Sans", "Nimbus Sans L", Tahoma, Geneva, "Helvetica Neue", Helvetica, Arial, sans-serif}.article-footer{border-top:1px solid #ddd;padding-top:1em;margin-top:1em}body{font-size:16px !important}.navbar .navbar-inner{background:#3c3f41}.navbar .brand{font-size:14px}.navbar .brand img{width:6em}.navbar .icon-wrench{margin:0 -0.5em 0 -0.5em;padding:0 1em 0 1em;height:20px}.navbar-inverse .nav .active a{background:#333638}.navbar-inverse .nav > li > a{color:#a7a7a7
}.navbar-inverse .btn-navbar{background:#333638}.navbar-inverse .nav > li a:hover,.navbar-inverse .btn{background:#333537 !important}@media (max-width: 979px) {.icon-wrench{padding-left:1em !important}}.breadcrumb{border-top-left-radius:0;border-top-right-radius:0}h1{margin-top:20px}.breadcrumb-container + .main-content h1{margin-top:0}.footer{padding:30px 0;margin-top:70px;border-top:1px solid #e5e5e5;background-color:#f5f5f5}.footer ul.footer-menu{list-style-type:none}.footer ul.footer-menu li{display:inline-block}.footer ul.footer-menu li + li{margin-left:0.5em}.footer ul.footer-menu li + li:before{margin-right:0.5em;content:"·";color:#999}.footer ul.menu li{display:inline-block}.footer ul.menu li + li{margin-left:0.5em}.footer .copyright{margin-left:25px}.main-content{min-height:100%}.gravatar{width:80px;height:80px;border-radius:2px;background:#eee}.empty-gravatar{width:0}.container{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}.container h1,.container h2,.container h4,.container h4,.container h5{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}article{font-family:Merriweather !important}article h1{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}article li + li{margin-top:0.5em}article div.code{background:#f9f9f9;border:1px solid #d1d1d1;position:relative;border-radius:0.2em;margin:0.25em 0 0.75em 0;min-height:2.5em}article code{color:#005580;font-size:14px;white-space:pre}article a.hoogle > code{color:#0088cc;font-size:14px;white-space:pre;border:0}article .expand-code{display:none}article pre{overflow:auto;word-wrap:normal}article code.active{display:block;max-height:430px}article h1{font-size:31.5px}article h3{font-size:17.5px}article h4{font-size:14px}article h5,article h6{font-size:11.9px}article p{line-height:1.7em}article h1 code,article h2 code,article h3 code,article h4 code,article h5 code,article h6 code{font-size:inherit !important}article h1 a,article h2 a,article h3 a,article h4 a,article h5 a,article h6 a{color:#444}article h1 a:before,article h2 a:before,article h3 a:before,article h4 a:before,article h5 a:before,article h6 a:before{margin-left:-1.5em;padding-right:0.5em;font-family:fontawesome;content:"\f0c1";font-size:20px;color:#fff}article h1 a:hover,article h2 a:hover,article h3 a:hover,article h4 a:hover,article h5 a:hover,article h6 a:hover{text-decoration:none;color:#0088cc}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#888}article h2{font-size:24.5px}article .popover{font-family:actor}article .popover h3.popover-title{font-family:actor !important;font-size:1em}article .popover .popover-content{width:15em;font-size:1em}article .controlsRun{display:block;padding:0.5em;text-align:right;background:#f2f2f2}article .controlsRun a.clone{margin-right:1em;font-family:actor;text-decoration:none}article .controlsRun a.clone span{padding-left:0.5em}article .controlsRun a.run,article .controlsRun a.reset,article .controlsRun a.show-code{font-size:16px}article .controlsRun a.run span,article .controlsRun a.reset span,article .controlsRun a.show-code span{display:none}article .controlsRun a.reset{margin-left:0.5em;color:#a2becc}article .controlsRun a.reset{display:none}article .controlsRun a.show-code{margin-right:0.75em}article .controlsRun a.run:hover,article .controlsRun a.show-code:hover{text-decoration:none}article .controlsRun a.show-code.active{color:#DC0D0D}article .controlsRun a[disabled]{color:#a2becc;cursor:default}article .collapse-area .collapse-header{background:#0088cc;color:#fff;padding:0.3em;cursor:pointer}article .collapse-area .hidden-toggle:before{content:"\f0d7";font-family:fontawesome;margin-right:0.5em;margin-left:0.25em}article .collapse-area .collapsed-files{overflow:auto;height:auto}article .collapse-area.collapse-disabled{display:none}article .collapse-area.collapse-area-off .collapsed-files{height:0px;overflow:hidden}article .collapse-area.collapse-area-off .hidden-toggle:before{content:"\f0da"}article .snippet-stdio .stdout{margin:0.5em;padding-right:2em;position:relative;word-wrap:break-word}article .snippet-stdio .stdin{-webkit-box-shadow:none;-moz-box-shadow:none;box-shadow:none;-webkit-transition:none;-moz-transition:none;-o-transition:none;transition:none;padding:0;margin:0}article .hoogle-results{margin:0.25em}article .hoogle-results .hoogle-inner{background:#fff;padding:0.5em;border-radius:3px;border:1px solid #ddd}article .hoogle-results .hoogle-inner .close-link{position:relative;float:right;margin-top:-0.5em;margin-right:-0.5em}article .snippet-output-errors{margin:1em 0.5em 0.5em 0.5em;position:relative}article .snippet-output-errors ul{list-style-type:none;margin:0;position:relative}article .snippet-output-errors pre{border:0;border-radius:0;padding:0.25em;margin:0;background:inherit;color:inherit}article .snippet-output-errors .close-link{color:inherit;background:inherit}article .snippet-editors{z-index:0;padding:0.25em}article .close-link{padding:0.5em;background:#eaeaea;border-bottom-left-radius:0.2em;border-top-right-radius:0.2em;position:absolute;top:0;right:0}article .close-link:hover{text-decoration:none}article .snippet-title{padding:0.5em 0 0 0.5em}article .snippet-title .snippet-icon{font-family:FontAwesome;display:inline-block;margin-right:0.5em}article .fullModuleCode + div .snippet-title{margin-top:0.5em;border-top:1px solid #ccc;padding-top:0.5em}article .CodeMirror{height:auto;min-height:1em;line-height:1.5em;background:transparent;font-size:14px !important}article .CodeMirror .highlighted{background:rgba(250, 210, 0, 0.45) !important}article .CodeMirror-widget{margin-left:2em;line-height:1.8}article .CodeMirror.collapsed{height:10em !important}article .editor .expander{text-align:center;display:block;padding:0.5em;text-decoration:none;border-bottom-left-radius:2px;border-bottom-right-radius:2px}article .editor .expander .ellipsis{background:white;border:1px solid #ccc;padding:0 0.5em;height:1em;line-height:0.5em;display:inline-block;color:#555;cursor:pointer}article .editor .expander .ellipsis:hover{background:#ddd;color:#333}article .web-runner{margin:0.5em;padding:0.5em;border:1px solid #ccc;border-radius:3px;background:#f5f5f5}article .web-runner iframe{border:0;margin-top:0.5em;margin-bottom:0;background:white}article .web-runner .controls i{cursor:pointer;color:#0088cc}article .web-runner .controls i:hover{color:#222}article .web-runner .controls i + i{margin-left:0.5em}article .web-runner .controls .icon-remove{float:right}article .hidden{display:block;visibility:visible}article .controlsShowHide{margin-bottom:0.5em}.tutorial-body{float:left !important}.tutorial-nav{float:right !important}@media (max-width: 979px) {.related-content{float:right}.author-name{display:block;margin-left:20px !important;padding-left:5px;margin-top:5px}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#fff}.tutorial-nav{float:none !important;width:auto !important}.tutorial-body{float:none !important;width:auto !important}}@media (min-width: 980px) and (max-width: 1199px) {.navbar-search{display:none}.tutorial-nav{width:200px}.tutorial-body{width:720px}}#accountPage h1{margin:20px 0 0 0}#accountPage h2{font-size:20px}.group-contents .span8{float:left}.group-contents .span4{float:right}.container > .alert-block{margin-top:1em}.alert{color:#aa874a
}.social{margin-bottom:.8em;display:block}.social a{text-decoration:none}.social i{font-size:1.1em;color:#fff;padding:0.25em;border-radius:0.25em;width:1em;display:inline-block;text-align:center}.social i.icon-twitter{background:#0088cc}.social i.icon-facebook{background:#3b5998
  }.social i.icon-google-plus{background:#dd4b39
  }.well pre{background:#fcfcfc}.well h2{margin-top:0}code{color:#005580;font-size:14px;white-space:pre}</style><!--[if lt IE 8]><link rel="stylesheet" href="https://www.schoolofhaskell.com/static/design/css/ie7.css?etag=TSMl9x1V"><![endif]--><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head><body class="not-logged-in" itemscope itemtype="http://schema.org/Product"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-H62P" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-H62P');</script><div class="navbar navbar-inverse navbar-static-top"><div class="navbar-inner"><div class="container"><a class="btn btn-navbar" type="button" data-toggle="collapse" data-target=".nav-collapse"><span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</a>
<a class="brand" href="/"><img src="/static/img/haskell-logo-wide.png" title="School of Haskell">
</a>
<div class="nav-collapse collapse"><ul class="nav"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>
</ul>
<form class="navbar-search pull-left" action="https://www.schoolofhaskell.com/search"><input class="search-query" type="text" placeholder="Search" name="search">
</form>
</div>
</div>
</div>
</div>
<div class="container breadcrumb-container"><div class="row"><div class="span12"><ul class="breadcrumb"><li><a href="https://www.schoolofhaskell.com/user/tel">Joseph Abrahamson</a>
<span class="divider">/</span>
</li>
<li><a href="https://www.schoolofhaskell.com/user/tel/lens-aeson-traversals-prisms">Lens/Aeson Traversals/Prisms</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container main-content"><div class="row"><div class="span12"><h1 itemprop="name">Lens/Aeson Traversals/Prisms</h1>
</div>
</div>
<div class="row"><div class="span7 meta"><p><span class="date">14 May 2014</span>
<span class="author"><a href="https://www.schoolofhaskell.com/user/tel">Joseph Abrahamson</a>
</span>
<span class="view-edit-link pull-right"><a class="view-source-link" href="https://www.schoolofhaskell.com/tutorial-raw/1503/41fe2778b5906b730dd97215f0d731f16ecbfca3">View Markdown source</a>
</span>
</p>
<p class="tags"></p>
</div>
</div>
<div class="row"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
<p class="alert">As of March 2020, School of Haskell has been switched to read-only mode.</p>
<div class="row" itemprop="desc"><div class="span4 tutorial-nav"><div class="related-content"><ul class="nav nav-tabs nav-stacked"><li><script>reddit_target='fpcomplete'</script>
<script src="https://redditstatic.s3.amazonaws.com/button/button1.js"></script>
</li>
<li><a href="https://www.schoolofhaskell.com/user/tel/lenses-from-scratch">Previous content: Lenses from Scratch</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user/tel/pretext-by-experiments-and-guesses">Next content: Pretext by experiments and guesses</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user/tel">See all content by Joseph Abrahamson</a>
</li>
</ul>

</div>
<div class="aside"><h3>Sections</h3>
<ul><li><a href="#you-could-have-invented-data-aeson-lens--and-maybe-you-already-have-">You could have invented Data.Aeson.Lens (and maybe you already have)</a><ul><li><a href="#failure-is-a-monad-right-">Failure is a monad right?</a></li></ul></li><li><a href="#a-short-diversion-on-the-nature-of-traversals">A short diversion on the nature of Traversals</a></li><li><a href="#traversing-json-with-prisms">Traversing JSON with Prisms</a></li></ul></div>
</div>
<div class="span8 tutorial-body" data-environment="ghc-7.8-stable-14.09">
<article><p>In the <a href="http://www.haskellcast.com/episode/001-edward-kmett-on-lenses/">first Haskell Cast podcast</a> Rein Henrichs and Chris Forno interviewed Edward Kmett in part about <code>lens</code> and it was suggested that <code>Prism</code>s don't have the same kind of introductory tutorial treatment. That's a shame, though. <code>Prism</code>s arise naturally all the time when using sum types.</p><h2 id="you-could-have-invented-data-aeson-lens--and-maybe-you-already-have-"><a href="#you-could-have-invented-data-aeson-lens--and-maybe-you-already-have-">You could have invented Data.Aeson.Lens (and maybe you already have)</a></h2><p>I learned to use <code>Prism</code>s when using <a href="http://hackage.haskell.org/package/lens"><code>lens</code></a> [1] with <a href="http://hackage.haskell.org/package/aeson"><code>aeson</code></a> so let us examine an extended use case to motivate using <code>Prism</code>s.</p><p>It's fairly common in dynamic languages to consume JSON like this</p><pre><code class="python">&gt; it = json.loads('[{&quot;someObject&quot; : { &quot;version&quot; : [1, 0, 0] }}]')
&gt; it[0][&quot;someObject&quot;][&quot;version&quot;][1]</code></pre><p>which might, say, be accessing the minor version number of some nested object. In Python here we use an isomorphism (i.e. a two-way mapping that establishes equivalence) between JSON types and fairly common Python types and then just destruct the JSON information as an &quot;array of dictionaries of dictionaries of arrays&quot;.</p><p>Python users translating that line to Haskell with the JSON library <a href="http://hackage.haskell.org/package/aeson"><code>aeson</code></a> can grow frustrated by the (pathological) example below showing how tedious the manual destructuring in Haskell is when you're forced to be explicit but don't know how to use <code>Lens</code>s or <code>Prism</code>s.</p><pre><code class="haskell">
import Prelude hiding (lookup)
import Data.HashMap.Strict (lookup)
import Data.Vector ((!?))

case decode &quot;[{\&quot;someObject\&quot; : { \&quot;version\&quot; : [1, 0, 0] }}]&quot; of
  Nothing        -&gt; error &quot;Oh, I guess sometimes the JSON string might be invalid...&quot;
  Just (Array a) -&gt;
    case a !? 0 of
      Nothing -&gt; error &quot;Oh, previously I assumed there was at least ONE object...&quot; 
      Just (Object o) -&gt;
        case lookup &quot;someObject&quot; o of
          ...
      Just _          -&gt; error &quot;Oh, what about if I don't actually have an object?&quot;
  Just _         -&gt; error &quot;Oh, what about if I don't actually have an array?&quot;</code></pre><p>Destructuring is <i>far</i> more explicit here and conflates getting the values with all kinds of &quot;schema validation&quot; errors.</p><p>Usually the next step is to learn to use the <code>ToJSON</code>/<code>FromJSON</code> machinery to fold all of your schema validation into <code>decode</code> and then build a really robust, independent serialization adapter for whatever internal ADTs you're using to actually model your domain. Which is great when you've got time to kill, but it doesn't really represent that original Python snippet which is far more likely to be a one-off JSON-munging script than a robust program.</p><p>So can we do better if we just want to either get our value or fail?</p><h3 id="failure-is-a-monad-right-"><a href="#failure-is-a-monad-right-">Failure is a monad right?</a></h3><p><a href="http://hackage.haskell.org/package/errors">Of</a> <a href="http://hackage.haskell.org/package/either">course</a> <a href="http://hackage.haskell.org/package/MaybeT">it</a> is. Let's pick <code>Maybe</code> and inject everything into it to consolidate those errors.</p><p>We'll need to extract a few helpers from the above</p><pre><code class="haskell">anObject :: Value -&gt; Maybe Object
anObject (Object m) = Just m
anObject _          = Nothing

anArray :: Value -&gt; Maybe Array
anArray (Array a) = Just a
anArray _         = Nothing</code></pre><p>and then using <code>do</code> notation the example is much clearer.</p><pre><code class="haskell">do json   &lt;- decode thatString
   ary    &lt;- anArray json
   zeroth &lt;- ary !? 0
   obj    &lt;- anObject zeroth
   keys   &lt;- lookup &quot;someObject&quot; obj
   keyObj &lt;- anObject keys
   ver    &lt;- lookup &quot;version&quot; key Obj
   verAry &lt;- anArray ver
   verAry !? 1</code></pre><p>which is much nicer and, for those with a touch of Monad-fu, can be further simplified by using <code>(&gt;=&gt;)</code> into something that's <i>almost</i> as nice as the original Python code while being far more explicit about the kinds of assumptions and failure modes that exist.</p><pre><code class="haskell">decode &gt;=&gt; anArray  &gt;=&gt; (!? 0) 
       &gt;=&gt; anObject &gt;=&gt; lookup &quot;someObject&quot;
       &gt;=&gt; anObject &gt;=&gt; lookup &quot;version&quot; 
       &gt;=&gt; anArray  &gt;=&gt; (!? 1)</code></pre><p>One way to think of this chain is it's a method of traversing our JSON structure by repeated descent into sum types like <code>Value</code>. Getting a <code>Nothing</code> indicates that the descent we would have liked to take is actually not available. With all this talk of &quot;repeated descent&quot; and &quot;traversing&quot; you can begin to expect that there might be a way to achieve this from within the <code>lens</code> ecosystem.</p><p>Basic <code>Lens</code>es don't quite work because they don't have a good notion of failure, but there is a straightforward and powerful way to encode this into <code>lens</code> and we'll see that it's essentially exactly what is done in <code>Data.Aeson.Lens</code>.</p><h2 id="a-short-diversion-on-the-nature-of-traversals"><a href="#a-short-diversion-on-the-nature-of-traversals">A short diversion on the nature of Traversals</a></h2><p>A Lens can usually be thought of as a first-class method of separating a piece of an object from its whole. In this light, we can think of <code>_1</code>, suitably specialized, as the split</p><pre><code>(a, b)   --&gt;    a    AND   ( _ ,  b )</code></pre><p>which then lets us operate by either retreiving the piece or updating the whole. An obvious generalization is the <code>Traversal</code> which lets us generalize our target to 0-or-more parts at once. This takes shape in <code>both :: Traversal' (a, a) a</code> which targets both the <code>fst</code> and <code>snd</code> element simultaneously or <code>each :: Traversal' [a] a</code> which targets all of the elements of a list at once.</p><p><code>Traversal</code>s are much more powerful than <code>Lens</code>es but, as usual, with more power comes less certainty. <code>Lens</code>es can be <code>view</code>ed or <code>(^.)</code>'d easily since they embody the guarantee that we're focused on exactly one part of the whole. <code>Traversal</code>s on the other hand can target subparts which may not exist. Consider what would happen if you tried to <code>view each</code> of a list. If <code>each</code> were a lens then <code>view elements</code> would have type <code>[a] -&gt; a</code> but there are two things that can go wrong:</p><ol><li><p>If the list is empty we'll have to throw an error</p></li><li><p>If the list has multiple elements we'll have to &quot;summarize&quot; them somehow.</p></li></ol><p>In order to implement <code>view</code> for a traversal, we'll need support from a <code>Monoid</code> instance for <code>a</code> so that we can handle case (1) with <code>mempty</code> and case (2) with <code>mappend</code>. This is why you can sometimes get weird errors in lens such as what happens when we try <code>view each &quot;foo&quot;</code></p><pre><code class="haskell">&lt;interactive&gt;:42:22:
    No instance for (Data.Monoid.Monoid Char)
      arising from a use of `each'</code></pre><p>as <code>view</code> is trying to combine the multiple subparts with a non-existent <code>Monoid</code> instance. If we try it instead like <code>view each [&quot;f&quot;, &quot;o&quot;, &quot;o&quot;]</code> we can use the (free) <code>Monoid</code> instance for <code>[a]</code></p><pre><code class="haskell">&gt; view each [&quot;f&quot;, &quot;o&quot;, &quot;o&quot;]
&quot;foo&quot;</code></pre><p>For convenience, <code>lens</code> gives us two variants on <code>view</code>/<code>(^.)</code> which pre-wrap our subparts in useful monoids. We have <code>preview</code>/<code>(^?)</code> which prewraps the subparts in <code>First</code> and <code>toListOf</code>/<code>(^..)</code> which prewraps the subparts in <code>[]</code>.</p><pre><code class="haskell">&gt; &quot;foo&quot; ^? each
Just 'f'

&gt; &quot;foo&quot; ^.. each
&quot;foo&quot;</code></pre><p>We'll make use of <code>(^?)</code> especially in the parts to come.</p><h2 id="traversing-json-with-prisms"><a href="#traversing-json-with-prisms">Traversing JSON with Prisms</a></h2><p>Remember that the trouble with using <code>Lens</code>es to peel off layers of our JSON structure is that our expectations about whether or not a layer can actually be peeled away may be incorrect and <code>Lens</code>es assume that we have exactly one valid subpart to target.</p><p>More generally, you might say that <code>Lens</code>es target product types well, picking one of several pieces to focus on, but have trouble with sums (coproducts) since we may not have any pieces at all for them to target.</p><p><code>Traversal</code>s solve this problem by using a <code>Monoid</code> instance to handle failure and multiple results well, but they do so at the cost of knowing anything at all about how many pieces are being targeted. This is sufficient for JSON, but a little bit of overkill. We know that there will be exactly 0 or 1 <code>Array</code>s in any <code>Value</code>. That notion is the first part of a <code>Prism</code>.</p><p>The <a href="http://hackage.haskell.org/package/lens-4.1.2/docs/Control-Lens-Prism.html">haddocks</a> say that a <code>Prism</code> is a Traversal that can also be turned around with re to obtain a Getter in the opposite direction. It turns out that &quot;turning around&quot; is a very powerful property that lets us rebuild entire structures from only their piece and the knowledge that they ought to be accessible via our prismatic <code>Traversal</code>. To drive the distinction home, consider a <code>Traversal</code> over the 3rd element in a list (it's called <code>ix 2</code>). It's 0-or-1 targeted, but given only a piece of the list and that <code>Traversal</code> you cannot rebuild the origin list uniquely. The Traversal laws hold for every Prism and we traverse at most 1 element.</p><p>0-or-1 target <code>Traversal</code>s that can be <a href="http://hackage.haskell.org/package/lens-4.1.2/docs/Control-Lens-Review.html">&quot;Reviewed&quot;</a> like this form exactly the <code>Prism</code>s. For instance, <code>lens</code> has an entire module and class devoted to <a href="http://hackage.haskell.org/package/lens-4.1.2/docs/Control-Lens-Cons.html"><code>Cons</code>-ing things on to the front of lists</a>—an operation that, unlike <code>ix 2</code> can be &quot;reviewed&quot;.</p><p>The place you typically will see <code>Prism</code>s is when desconstructing a sum type. Each disjoint constructor will get its own <code>Prism</code> as any value of the sum has either 0 or 1 of those constructors being used. This is exactly the notion we need to &quot;lensify&quot; the <code>aeson</code> <code>Value</code> type, and, indeed, that's exactly what <code>Data.Aeson.Lens</code> from <code>lens</code> provides.</p><pre><code class="haskell">_Object :: Prism' Value Object
_Object = prism' anObject Object

_Array  :: Prism' Value Array
_Array = prism' anArray Array

_String :: Prism' Value String
_String = prism' aString String

_Number :: Prism' Value Number
_Number = prism' aNumber Number</code></pre><p>Which is not much more than an introduction of our &quot;failing deconstructors&quot; from the first section.</p><p><code>Data.Aeson.Lens</code> also provides a few <code>Traversal</code>s based upon <a href="http://hackage.haskell.org/package/lens-4.1.2/docs/Control-Lens-At.html"><code>ix</code></a> but specialized to JSON types</p><pre><code class="haskell">key :: Text -&gt; Traversal' Object Value
nth :: Int  -&gt; Traversal' Array Value</code></pre><p>Using these <code>Prism</code>s and <code>Traversal</code>s we can pick apart our JSON object as we please.</p><pre><code class="haskell">case decode theString of
  Nothing -&gt; Nothing
  Just it -&gt; it ^? _Array  . nth 0
                 . _Object . key &quot;someObject&quot;
                 . _Object . key &quot;version&quot;
                 . _Array  . nth 1</code></pre><p>Or, even better, by using the built-in <code>Data.Aeson.Lens</code> isomorphisms and type classes we can write this directly.</p><pre><code class="haskell">theString ^? nth 0 . key &quot;someObject&quot; . key &quot;version&quot; . nth 1</code></pre><p>and have the 1-or-0 target nature of <code>Prism</code>s work its magic in the background. Finally, we're looking at a Haskell example which rivals the original Python's terseness without sacrificing nearly as much type safety.</p><p>Want to play with the example? Here's a bit of preamble to get you going in ghci.</p><pre><code class="haskell">-- to play with this example from ghci,
-- install lens 4 or newer and :set -XOverloadedStrings
-- OverloadedStrings is so it can automatically turn the String literals into Text
-- values which is the type used for indexing into Object.

import Data.Aeson
import Data.Aeson.Lens
import Control.Lens

-- this code is intended for ghci experimentation, so we use &quot;let&quot; to bind a value to a name
let jsonBlob = &quot;[{\&quot;someObject\&quot;: {\&quot;version\&quot;: [1, 0, 3]}}]&quot;

-- example from above
let myVal = jsonBlob ^? nth 0 . key &quot;someObject&quot; . key &quot;version&quot; . nth 1

-- What progressively composing the prisms looks like, note the composition order:
-- λ&gt; jsonBlob ^? nth 0
Just (Object fromList
       [(&quot;someObject&quot;,
         Object fromList
           [(&quot;version&quot;,Array
             (fromList [Number 1.0, Number 0.0, Number 3.0]))])])

-- λ&gt; jsonBlob ^? nth 0 . key &quot;someObject&quot;
Just (Object fromList
       [(&quot;version&quot;,
         Array (fromList [Number 1.0, Number 0.0, Number 3.0]))])

-- λ&gt; jsonBlob ^? nth 0 . key &quot;someObject&quot; . key &quot;version&quot;
Just (Array (fromList [Number 1.0, Number 0.0, Number 3.0]))

-- λ&gt; jsonBlob ^? nth 0 . key &quot;someObject&quot; . key &quot;version&quot; . nth 1
Just (Number 0.0)</code></pre><hr /><p>(Thanks for commentary and corrections: acow, Effnote, edwardk, shachaf. Thanks for updating this to be current for the <code>lens-4.*</code> series to Chris Allen (@bitemyapp))</p><p><a href="http://www.reddit.com/r/haskell/comments/1l64oe/lensaeson_traversalprism/">Comments on Reddit</a></p><p>[1] Note that that <i>isn't</i> <a href="http://hackage.haskell.org/package/aeson-lens"><code>aeson-lens</code></a>, which is a similar package that looks like a bunch of <code>Lens</code>es but is actually invalid, in no small part because it doesn't invoke any <code>Prism</code>s. Also, <code>lens-aeson</code> has been deprecated and its support for Aeson has been merged into the main <code>lens</code> library.</p></article>


</div>
</div>
<div class="row article-footer"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
</div>
<div class="footer"><div class="container"><div class="row"><div class="span12"><ul class="menu"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>

<li><a class="brand" href="https://fpcomplete.com">Sponsored by:
<img src="/static/img/logo.png" title="FPComplete">
</a>
</li>
</ul>
</div>
</div>
<div class="row"><div class="span12"></div>
</div>
</div>
</div>
<link rel="stylesheet" type="text/css" href="/static/bootstrap/css/bootstrap-responsive.css" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://www.schoolofhaskell.com/static/combined/Y-3k9_tW.js"></script><script>$(function(){
  $("a.logout").click(function(){
    var form = $("<form method='post'/>");
    form.attr("action", $(this).attr("href"));
    $("body").append(form);
    form.submit();
    return false;
  });
});

$(function(){
    $('.sociallinksunicode a').each(function(){
        $(this).attr('href',$(this).attr('href').replace('$url$',document.location));
    });
});

$(function(){
  // If we need to select a user/select a password then show the
  // details confirmation form, otherwise enable the getting started
  // section.
  if($('.alert-block a').text().match(/(selected a username|change your password)/)) {
    $("#confirm-details").show();
    $("#confirm-details #inputUsername").focus();
  } else {
    $("#get-started").removeClass('disabled').addClass('enabled');
  }

  // For lack of a plain HTML validation story this will do.
  $('.welcome-page').each(function(){
    $('form').submit(check);
  });
  function check(){
    setTimeout(check,500);
    var error = false;
    $('.error').removeClass('error');
    $('#enter-details input').each(function(){
      if($(this).val() == '') {
        $(this).parent().parent().addClass('error');
        error = true;
      }
    });
    if(error) return false;
    if($('[name=password]').val() == $('[name=confirm]').val()) {
      $('#confirm').removeClass('error');
      return true;
    } else {
      $('#confirm').addClass('error');
      return false;
    }
  }
});

$(function(){
  // When scrolling over a snippet editor, activate the "clone in IDE" popovers
  $('article').each(function(){
    var n = 100;
    var wait = 10000;
    function check(){
      if($('.clone').length == 0) {
        setTimeout(check,n);
        return;
      }
      var activated = $.cookie('clone-popover');
      if (activated) return;
      var activate = false;
      $('.controlsRun:onScreen').each(function(){
        $.cookie('clone-popover', 'true', { expires: 30, path: '/' });
        activate = true;
        return false;
      });
      if(activate) {
          $('.clone').each(function(){
              // The bootstrap API is rather unreasonable to say the
              // least.
              next = $(this).parent();
              var title = next.attr('title');
              next.attr('data-content',$(this).attr('data-content'));
              next.attr('title',$(this).attr('title'));
              next.popover('show',{
                  title: $(this).attr('title')
              });
              next.attr('title',title);
          });
          setTimeout(function(){
              $('.clone').each(function(){
                  $(this).parent().popover('hide');
              });
          },wait);
      } else {
        setTimeout(check,n);
      }
    }
    setTimeout(check,n);
  });
});

// onScreen jQuery plugin v0.2.1
// (c) 2011-2013 Ben Pickles
//
// http://benpickles.github.com/onScreen
//
// Released under MIT license.
(function(a){a.expr[":"].onScreen=function(b){var c=a(window),d=c.scrollTop(),e=c.height(),f=d+e,g=a(b),h=g.offset().top,i=g.height(),j=h+i;return h>=d&&h<f||j>d&&j<=f||i>e&&h<=d&&j>=f}})(jQuery);

/*!
 * jQuery Cookie Plugin v1.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function($, document) {

  var pluses = /\+/g;
  function raw(s) {
    return s;
  }
  function decoded(s) {
    return decodeURIComponent(s.replace(pluses, ' '));
  }

  $.cookie = function(key, value, options) {

    // key and at least value given, set cookie...
    if (arguments.length > 1 && (!/Object/.test(Object.prototype.toString.call(value)) || value == null)) {
      options = $.extend({}, $.cookie.defaults, options);

      if (value == null) {
	options.expires = -1;
      }

      if (typeof options.expires === 'number') {
	var days = options.expires, t = options.expires = new Date();
	t.setDate(t.getDate() + days);
      }

      value = String(value);

      return (document.cookie = [
	encodeURIComponent(key), '=', options.raw ? value : encodeURIComponent(value),
	options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
	options.path    ? '; path=' + options.path : '',
	options.domain  ? '; domain=' + options.domain : '',
	options.secure  ? '; secure' : ''
      ].join(''));
    }

    // key and possibly options given, get cookie...
    options = value || $.cookie.defaults || {};
    var decode = options.raw ? raw : decoded;
    var cookies = document.cookie.split('; ');
    for (var i = 0, parts; (parts = cookies[i] && cookies[i].split('=')); i++) {
      if (decode(parts.shift()) === key) {
	return decode(parts.join('='));
      }
    }
    return null;
  };
  $.cookie.defaults = {};})(jQuery, document);
</script><!--[if lt IE 10]><script src="https://www.schoolofhaskell.com/static/design/js/ie.js?etag=ayV2DuJ0"></script><![endif]--><script>if(!window.location.href.match(/localhost/)){var track = '/tutorial/user/tel/lens-aeson-traversals-prisms';
window._gaq = [['_setAccount','UA-36928035-1'],track != ''? ['_trackPageview',track] : ['_trackPageview']
,['_trackPageLoadTime']];window._gaq.push(['_setCustomVar',1,'Section','School of Haskell',3]);
window._gaq.push(['_setCustomVar',2,'User Type','Visitor',1]);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);

})();}</script>
<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.  chromium.org/developers/how-tos/chrome-frame-getting-started --><!--[if lt IE 7 ]><script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script><script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script><![endif]--></body></html>