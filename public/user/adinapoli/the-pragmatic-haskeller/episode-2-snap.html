<!DOCTYPE html>
<html><head><title>Episode 2 - Snap - School of Haskell | School of Haskell</title><meta http-equiv="x-ua-compatible" content="IE=9"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="google-site-verification" content="Rfxk2TdeMMXEXHgJ2_OO8Rt3hPbQSDao0OXQV_n6z_s" /><link href="//fonts.googleapis.com/css?family=Merriweather" rel="stylesheet" type="text/css"><link href="https://www.schoolofhaskell.com/recent-content/feed" type="application/rss+xml" rel="alternate" title="Recently published content">
<link rel="stylesheet" href="https://www.schoolofhaskell.com/static/combined/UlwEHVcM.css"><style>.social{margin-right:1em}h1{font-family:Merriweather !important}article{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}h1,h2,h3,h4,h4,h5{font-family:Merriweather !important}.editor p{font-family:Frutiger, "Frutiger Linotype", Univers, Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans Condensed", "Liberation Sans", "Nimbus Sans L", Tahoma, Geneva, "Helvetica Neue", Helvetica, Arial, sans-serif}.article-footer{border-top:1px solid #ddd;padding-top:1em;margin-top:1em}body{font-size:16px !important}.navbar .navbar-inner{background:#3c3f41}.navbar .brand{font-size:14px}.navbar .brand img{width:6em}.navbar .icon-wrench{margin:0 -0.5em 0 -0.5em;padding:0 1em 0 1em;height:20px}.navbar-inverse .nav .active a{background:#333638}.navbar-inverse .nav > li > a{color:#a7a7a7
}.navbar-inverse .btn-navbar{background:#333638}.navbar-inverse .nav > li a:hover,.navbar-inverse .btn{background:#333537 !important}@media (max-width: 979px) {.icon-wrench{padding-left:1em !important}}.breadcrumb{border-top-left-radius:0;border-top-right-radius:0}h1{margin-top:20px}.breadcrumb-container + .main-content h1{margin-top:0}.footer{padding:30px 0;margin-top:70px;border-top:1px solid #e5e5e5;background-color:#f5f5f5}.footer ul.footer-menu{list-style-type:none}.footer ul.footer-menu li{display:inline-block}.footer ul.footer-menu li + li{margin-left:0.5em}.footer ul.footer-menu li + li:before{margin-right:0.5em;content:"·";color:#999}.footer ul.menu li{display:inline-block}.footer ul.menu li + li{margin-left:0.5em}.footer .copyright{margin-left:25px}.main-content{min-height:100%}.gravatar{width:80px;height:80px;border-radius:2px;background:#eee}.empty-gravatar{width:0}.container{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}.container h1,.container h2,.container h4,.container h4,.container h5{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}article{font-family:Merriweather !important}article h1{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}article li + li{margin-top:0.5em}article div.code{background:#f9f9f9;border:1px solid #d1d1d1;position:relative;border-radius:0.2em;margin:0.25em 0 0.75em 0;min-height:2.5em}article code{color:#005580;font-size:14px;white-space:pre}article a.hoogle > code{color:#0088cc;font-size:14px;white-space:pre;border:0}article .expand-code{display:none}article pre{overflow:auto;word-wrap:normal}article code.active{display:block;max-height:430px}article h1{font-size:31.5px}article h3{font-size:17.5px}article h4{font-size:14px}article h5,article h6{font-size:11.9px}article p{line-height:1.7em}article h1 code,article h2 code,article h3 code,article h4 code,article h5 code,article h6 code{font-size:inherit !important}article h1 a,article h2 a,article h3 a,article h4 a,article h5 a,article h6 a{color:#444}article h1 a:before,article h2 a:before,article h3 a:before,article h4 a:before,article h5 a:before,article h6 a:before{margin-left:-1.5em;padding-right:0.5em;font-family:fontawesome;content:"\f0c1";font-size:20px;color:#fff}article h1 a:hover,article h2 a:hover,article h3 a:hover,article h4 a:hover,article h5 a:hover,article h6 a:hover{text-decoration:none;color:#0088cc}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#888}article h2{font-size:24.5px}article .popover{font-family:actor}article .popover h3.popover-title{font-family:actor !important;font-size:1em}article .popover .popover-content{width:15em;font-size:1em}article .controlsRun{display:block;padding:0.5em;text-align:right;background:#f2f2f2}article .controlsRun a.clone{margin-right:1em;font-family:actor;text-decoration:none}article .controlsRun a.clone span{padding-left:0.5em}article .controlsRun a.run,article .controlsRun a.reset,article .controlsRun a.show-code{font-size:16px}article .controlsRun a.run span,article .controlsRun a.reset span,article .controlsRun a.show-code span{display:none}article .controlsRun a.reset{margin-left:0.5em;color:#a2becc}article .controlsRun a.reset{display:none}article .controlsRun a.show-code{margin-right:0.75em}article .controlsRun a.run:hover,article .controlsRun a.show-code:hover{text-decoration:none}article .controlsRun a.show-code.active{color:#DC0D0D}article .controlsRun a[disabled]{color:#a2becc;cursor:default}article .collapse-area .collapse-header{background:#0088cc;color:#fff;padding:0.3em;cursor:pointer}article .collapse-area .hidden-toggle:before{content:"\f0d7";font-family:fontawesome;margin-right:0.5em;margin-left:0.25em}article .collapse-area .collapsed-files{overflow:auto;height:auto}article .collapse-area.collapse-disabled{display:none}article .collapse-area.collapse-area-off .collapsed-files{height:0px;overflow:hidden}article .collapse-area.collapse-area-off .hidden-toggle:before{content:"\f0da"}article .snippet-stdio .stdout{margin:0.5em;padding-right:2em;position:relative;word-wrap:break-word}article .snippet-stdio .stdin{-webkit-box-shadow:none;-moz-box-shadow:none;box-shadow:none;-webkit-transition:none;-moz-transition:none;-o-transition:none;transition:none;padding:0;margin:0}article .hoogle-results{margin:0.25em}article .hoogle-results .hoogle-inner{background:#fff;padding:0.5em;border-radius:3px;border:1px solid #ddd}article .hoogle-results .hoogle-inner .close-link{position:relative;float:right;margin-top:-0.5em;margin-right:-0.5em}article .snippet-output-errors{margin:1em 0.5em 0.5em 0.5em;position:relative}article .snippet-output-errors ul{list-style-type:none;margin:0;position:relative}article .snippet-output-errors pre{border:0;border-radius:0;padding:0.25em;margin:0;background:inherit;color:inherit}article .snippet-output-errors .close-link{color:inherit;background:inherit}article .snippet-editors{z-index:0;padding:0.25em}article .close-link{padding:0.5em;background:#eaeaea;border-bottom-left-radius:0.2em;border-top-right-radius:0.2em;position:absolute;top:0;right:0}article .close-link:hover{text-decoration:none}article .snippet-title{padding:0.5em 0 0 0.5em}article .snippet-title .snippet-icon{font-family:FontAwesome;display:inline-block;margin-right:0.5em}article .fullModuleCode + div .snippet-title{margin-top:0.5em;border-top:1px solid #ccc;padding-top:0.5em}article .CodeMirror{height:auto;min-height:1em;line-height:1.5em;background:transparent;font-size:14px !important}article .CodeMirror .highlighted{background:rgba(250, 210, 0, 0.45) !important}article .CodeMirror-widget{margin-left:2em;line-height:1.8}article .CodeMirror.collapsed{height:10em !important}article .editor .expander{text-align:center;display:block;padding:0.5em;text-decoration:none;border-bottom-left-radius:2px;border-bottom-right-radius:2px}article .editor .expander .ellipsis{background:white;border:1px solid #ccc;padding:0 0.5em;height:1em;line-height:0.5em;display:inline-block;color:#555;cursor:pointer}article .editor .expander .ellipsis:hover{background:#ddd;color:#333}article .web-runner{margin:0.5em;padding:0.5em;border:1px solid #ccc;border-radius:3px;background:#f5f5f5}article .web-runner iframe{border:0;margin-top:0.5em;margin-bottom:0;background:white}article .web-runner .controls i{cursor:pointer;color:#0088cc}article .web-runner .controls i:hover{color:#222}article .web-runner .controls i + i{margin-left:0.5em}article .web-runner .controls .icon-remove{float:right}article .hidden{display:block;visibility:visible}article .controlsShowHide{margin-bottom:0.5em}.tutorial-body{float:left !important}.tutorial-nav{float:right !important}@media (max-width: 979px) {.related-content{float:right}.author-name{display:block;margin-left:20px !important;padding-left:5px;margin-top:5px}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#fff}.tutorial-nav{float:none !important;width:auto !important}.tutorial-body{float:none !important;width:auto !important}}@media (min-width: 980px) and (max-width: 1199px) {.navbar-search{display:none}.tutorial-nav{width:200px}.tutorial-body{width:720px}}#accountPage h1{margin:20px 0 0 0}#accountPage h2{font-size:20px}.group-contents .span8{float:left}.group-contents .span4{float:right}.container > .alert-block{margin-top:1em}.alert{color:#aa874a
}.social{margin-bottom:.8em;display:block}.social a{text-decoration:none}.social i{font-size:1.1em;color:#fff;padding:0.25em;border-radius:0.25em;width:1em;display:inline-block;text-align:center}.social i.icon-twitter{background:#0088cc}.social i.icon-facebook{background:#3b5998
  }.social i.icon-google-plus{background:#dd4b39
  }.well pre{background:#fcfcfc}.well h2{margin-top:0}code{color:#005580;font-size:14px;white-space:pre}</style><!--[if lt IE 8]><link rel="stylesheet" href="https://www.schoolofhaskell.com/static/design/css/ie7.css?etag=TSMl9x1V"><![endif]--><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head><body class="not-logged-in" itemscope itemtype="http://schema.org/Product"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-H62P" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-H62P');</script><div class="navbar navbar-inverse navbar-static-top"><div class="navbar-inner"><div class="container"><a class="btn btn-navbar" type="button" data-toggle="collapse" data-target=".nav-collapse"><span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</a>
<a class="brand" href="/"><img src="/static/img/haskell-logo-wide.png" title="School of Haskell">
</a>
<div class="nav-collapse collapse"><ul class="nav"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>
</ul>
<form class="navbar-search pull-left" action="https://www.schoolofhaskell.com/search"><input class="search-query" type="text" placeholder="Search" name="search">
</form>
</div>
</div>
</div>
</div>
<div class="container breadcrumb-container"><div class="row"><div class="span12"><ul class="breadcrumb"><li><a href="https://www.schoolofhaskell.com/user/adinapoli">Alfredo Di Napoli</a>
<span class="divider">/</span>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller">The Pragmatic Haskeller</a>
<span class="divider">/</span>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller/episode-2-snap">Episode 2 - Snap</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container main-content"><div class="row"><div class="span12"><h1 itemprop="name">Episode 2 - Snap</h1>
</div>
</div>
<div class="row"><div class="span7 meta"><p><span class="date">14 Apr 2013</span>
<span class="author"><a href="https://www.schoolofhaskell.com/user/adinapoli">Alfredo Di Napoli</a>
</span>
<span class="view-edit-link pull-right"><a class="view-source-link" href="https://www.schoolofhaskell.com/tutorial-raw/2810/6a767506a9c64b901af43c14a67ae2dea8edd574">View Markdown source</a>
</span>
</p>
<p class="tags"></p>
</div>
</div>
<div class="row"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
<p class="alert">As of March 2020, School of Haskell has been switched to read-only mode.</p>
<div class="row" itemprop="desc"><div class="span4 tutorial-nav"><div class="related-content"><ul class="nav nav-tabs nav-stacked"><li><script>reddit_target='fpcomplete'</script>
<script src="https://redditstatic.s3.amazonaws.com/button/button1.js"></script>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller/episode-3-configurator">Previous content: Episode 3 - Configurator</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller/episode-1-json">Next content: Episode 1 - JSON</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller">Go up to: The Pragmatic Haskeller</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli">See all content by Alfredo Di Napoli</a>
</li>
</ul>

</div>
<div class="aside"><h3>Sections</h3>
<ul><li><a href="#foreword">Foreword</a></li><li><a href="#our-barebone-web-application">Our barebone web application</a></li><li><a href="#different-levels-of-granularity">Different levels of granularity</a></li><li><a href="#printing-our-recipe-from-an-external-file">Printing our recipe from an external file</a></li><li><a href="#build-a-more-structured-snap-application">Build a more structured Snap application</a></li><li><a href="#snaplets">Snaplets</a><ul><li><a href="#snaplets">Snaplets</a></li></ul></li><li><a href="#putting-everything-together">Putting everything together</a></li><li><a href="#conclusions">Conclusions</a></li><li><a href="#external-references">External References</a></li><li><a href="#the-code">The code</a></li><li><a href="#next-time">Next Time</a></li></ul></div>
</div>
<div class="span8 tutorial-body" data-environment="ghc-7.8-stable-14.09">
<article><h2 id="foreword"><a href="#foreword">Foreword</a></h2><p>This is part of <a href="https://github.com/cakesolutions/the-pragmatic-haskeller">The Pragmatic Haskeller</a> series.</p><p><b>At the moment, the examples of this post are not runnable.</b></p><h2 id="our-barebone-web-application"><a href="#our-barebone-web-application">Our barebone web application</a></h2><p>Now that we have our barebone Haskell representation of a recipe, it's time
to spread the news to the world. Which better place than Internet? Haskell has
a good numbers of alternatives when it comes to web development. Here are
several libraries which are part of our toolbelt:</p><ul><li><a href="http://www.yesodweb.com/">Yesod</a> (which runs School of Haskell)</li><li><a href="http://snapframework.com/">Snap</a>  (the one used for this tutorial)</li><li><a href="http://www.happstack.com/page/view-page-slug/1/happstack">Happstack</a></li><li><a href="https://github.com/xich/scotty">Scotty</a></li><li><a href="http://hackage.haskell.org/package/MFlow">MFlow</a></li></ul><p>I've added to the list also two &quot;outsiders&quot;, projects which are unknown to most
users but that still might be interesting for someone. Said that, the first three
of the list are the most prominent ones. It's not my intention start a comparison,
so let's move further. For The purposes of this episode, I've used Snap, mainly
 because I love its code design, most of its design choices because I'm a 
<code>forever $ print &quot;tiny&quot;</code> <a href="https://github.com/snapframework/snap/blob/master/CONTRIBUTORS">contributor</a>.</p><p>Snap can be daunting at first, because the documentation on the website is
very slick and it lacks a sort of &quot;tutorial for dummies&quot; which guides you
through every aspect of your app development.</p><h2 id="different-levels-of-granularity"><a href="#different-levels-of-granularity">Different levels of granularity</a></h2><p>Like most web frameworks out there, Snap has a scaffolding utility to generate
a fully working web application out of the box. Before unravelling the magic
command, let me show you how succinct can be writing a small application
listening on a port and spitting out &quot;Hello World!&quot;:</p><pre><code class="haskell">{-# START_FILE Version1.hs #-}
{-# LANGUAGE OverloadedStrings #-}

import Snap

site :: Snap ()
site = writeText &quot;Hello Pragmatic Haskeller!&quot;

main :: IO ()
main = quickHttpServe site</code></pre><p>If you ignore the pragma and the type signature, it's three lines of code!
You can run it with <code>runhaskell Version1.hs</code> and it will do what you expect.</p><h2 id="printing-our-recipe-from-an-external-file"><a href="#printing-our-recipe-from-an-external-file">Printing our recipe from an external file</a></h2><p>Right now, our app is not so exciting after all; what if we make it display our
parsed Haskell data structure? That would be a start! This example shows a sort
of Snap's best practice: for each resource we ask, we implement an handler,
responsible to implement the logic. This example might not show immediately
what I'm talking about, but I hope everything will be clarified with the last
version of our server:</p><pre><code class="haskell">{-# START_FILE Version2.hs #-}
{-# LANGUAGE OverloadedStrings #-}

module Pragmatic.Server where

import Prelude hiding (readFile)
import Snap
import Data.Aeson
import Pragmatic.Types
import Pragmatic.JSON.Parser
import Data.Text as T
import Data.ByteString.Lazy

showRecipe :: ByteString -&gt; Snap ()
showRecipe toParse = writeText parseRecipe
  where parseRecipe = case (eitherDecode' toParse :: Either String Recipe) of
                        Left e -&gt; T.pack e
                        Right r -&gt; T.pack . show $ r

app :: ByteString -&gt; Snap ()
app toParse = route [(&quot;/recipe&quot;, showRecipe toParse)]

main :: IO ()
main = do
    toParse &lt;- readFile &quot;recipe.json&quot;
    quickHttpServe (app toParse)</code></pre><p>Bonus tip: In this example, we could have make a slightly better design choice;
instead of creating an impure function to live inside the <code>Snap</code> monad, we
could have written <code>showRecipe</code> in a pure way, using <code>writeText</code> directly inside
our &quot;route manager&quot;, but for the purposes of this example it doesn't really matter,
but is in general a good suggestion to follow. Whenever you can, always write
pure functions; it will translate in code easier to reason about, reuse and test
but is in general a good suggestion to follow. Whenever you can, always write
pure functions; it will translate in code easier to reason about, reuse and test.</p><h2 id="build-a-more-structured-snap-application"><a href="#build-a-more-structured-snap-application">Build a more structured Snap application</a></h2><p>As I told you, Snap already provides a scaffolding utility to scrap some
boilerplate. When you first run <code>snap init</code> into an empty directory, it will
create a bunch of files:</p><ul><li><code>Main.hs</code></li><li><code>Application.hs</code></li><li><code>Site.hs</code></li></ul><p>While the first one is just to bootstrap the application and you rarely will
need to modify it, I find effective to think about the other two like the place
where your application stack will live (more on that later) and where your
resource handlers will live. So let's take a peek to these two guys.</p><h2 id="snaplets"><a href="#snaplets">Snaplets</a></h2><p>Let's take a look to <code>Application.hs</code>:</p><pre><code class="haskell">{-# START_FILE Application.hs #-}
{-# LANGUAGE TemplateHaskell #-}

module Pragmatic.Server.Application where

import Control.Lens
import Snap.Snaplet
import Snap.Snaplet.MongoDB.Core

-------------------------------------------------------------------------------
data Pragmatic = Pragmatic 
  { _db :: Snaplet MongoDB }

makeLenses ''Pragmatic


-------------------------------------------------------------------------------
instance HasMongoDB Pragmatic where
    getMongoDB app = view snapletValue (view db app)


-------------------------------------------------------------------------------
type AppHandler = Handler Pragmatic Pragmatic</code></pre><p>You'll notice a couple of things:</p><ul><li>We have this mysterious monad called <code>Snaplet</code></li><li>We do something with MongoDB</li><li>We have that type synonym called <code>AppHandler</code></li></ul><p>Let's go briefly over these three points.</p><h3 id="snaplets"><a href="#snaplets">Snaplets</a></h3><p>One of Snap's strengths is represented by Snaplets, auto-contained piece of
functionality we can reuse to build our website. Once you grok it, the entire
mechanism is quite powerful. The classic example is a logger. Suppose you want
to give your website logging capabilities. You could implement logging 
throughout the webapp, or &quot;bundle&quot; it in a series of modules other developers
could use, &quot;jacking-in&quot; your bundle. This is the idea behind Snaplets. The are
a lot of Snaplets coded by the community, from DB to Javascript integration.
I've chosen <a href="http://hackage.haskell.org/package/snaplet-mongodb-minimalistic">snaplet-mongodb-minimalistic</a>: all I have to do is to &quot;plumb&quot; it
to my application <code>App</code>, tell Snap how to initialise it (see later) and we have MongoDB in
our app! Last but not least, that curious type synonym is for accessing our
application stack: the outer monad remind us in which environment we are operating
in, so that the inner monad can change according to which Snaplet we are &quot;targeting&quot;.
You can think the <code>AppHandler</code> as the &quot;root&quot; of our application. If you look
carefully you will note AppHandler has kind <code>* -&gt; *</code>, so it's still waiting for
something.. speculations? It's the return type, aka what our handler will yield!</p><h2 id="putting-everything-together"><a href="#putting-everything-together">Putting everything together</a></h2><p>What is left? Well, here is <code>Site.hs</code> (long file incoming!):</p><pre><code class="haskell">{-# START_FILE Site.hs #-}
{-# LANGUAGE OverloadedStrings #-}

module Pragmatic.Server.Site (app) where

import Data.Aeson
import Data.AesonBson
import Data.ByteString (ByteString)
import qualified Data.ByteString.Lazy as BL
import Data.Text as T
import Database.MongoDB
import Pragmatic.JSON.Parser
import Pragmatic.Server.Application
import Pragmatic.Types
import Snap
import Snap.Snaplet.MongoDB

-------------------------------------------------------------------------------
handleIndex :: AppHandler ()
handleIndex = writeText &quot;Welcome to the pragmatic bakery!&quot;


-------------------------------------------------------------------------------
-- Show the underlying Haskell data structure of recipe.json
handleShow :: AppHandler ()
handleShow = do
    toParse &lt;- liftIO $ BL.readFile &quot;recipe.json&quot;
    writeText $ eitherParse toParse
  where eitherParse tp = case (eitherDecode' tp :: Either String Object) of
                           Left e -&gt; T.pack e
                           Right r -&gt; T.pack . show $ r


-------------------------------------------------------------------------------
-- Here we try to store the recipe.json with the new Data.AesonBson
handleStore :: AppHandler ()
handleStore = do
    toParse &lt;- liftIO $ BL.readFile &quot;recipe.json&quot;
    result &lt;- storeRecipe toParse
    writeText $ T.pack . show $ result


-------------------------------------------------------------------------------
parseRecipe :: BL.ByteString -&gt; Either String Object
parseRecipe = eitherDecode'

-------------------------------------------------------------------------------
storeRecipe :: BL.ByteString -&gt; AppHandler (Either String Object)
storeRecipe recipe = case parseRecipe recipe of
      Left f -&gt; return $ Left f
      Right r -&gt; do
        res &lt;- eitherWithDB $ insert &quot;recipes&quot; $ toBson r
        case res of
          Left _ -&gt; return $ Left &quot;Failed to store the recipe.&quot;
          Right _ -&gt; return $ Right r


-------------------------------------------------------------------------------
routes :: [(ByteString, Handler Pragmatic Pragmatic ())]
routes = [(&quot;/&quot;, handleIndex)
         , (&quot;/show&quot;, handleShow)
         , (&quot;/store&quot;, handleStore)
         ]


-------------------------------------------------------------------------------
app :: SnapletInit Pragmatic Pragmatic
app = makeSnaplet &quot;pragmatic&quot; &quot;Pragmatic web service&quot; Nothing $ do
    d &lt;- nestSnaplet &quot;db&quot; db $ mongoDBInit 10 (host &quot;127.0.0.1&quot;) &quot;pragmatic-haskeller&quot;
    addRoutes routes
    return $ Pragmatic d</code></pre><p>It's a lot of code, but don't be scared about it, you have already seen part
of it. If you look carefully, all those &quot;handler&quot; are like the function we
wrote in Version2, but on steroid, because now we yield an <code>AppHandler a</code> rather
than an humble <code>Snap a</code>. Apart from that, I want to point your attention on
three things:</p><ul><li><p>The <code>app</code> function does the heavy bootstrapping; this is something you'll
always need to do. For each Snaplet you add to your application, you need to
also specify how to initialise it. Here we are initialising a new db called
&quot;the-pragmatic-haskeller&quot; using the <code>mongod</code> running on localhost.</p></li><li><p><code>storeRecipe</code> uses the MongoDB snaplet to save our recipe into a collection
called &quot;recipes&quot;. The conversion to BSON is free and is offered by <a href="https://github.com/adinapoli/aeson-bson">aeson-bson</a>
(many thanks to the original authors for their job, this is my shameless fork).</p></li></ul><p><b>Nota bene:</b> At the moment <code>aeson-bson</code> is not on Hackage. It's a shameless
fork, with minimal tweaks from the original work of Niklas Hambüchen and
Andras Slemmer. The difference is mainly in a different name (all lowercase,
dashed) and a slightly different interface. I'm pretty sure you can plug out
my fork and use the original version without any substantial difference.
If you want the very same version I use, install it from github.</p><h2 id="conclusions"><a href="#conclusions">Conclusions</a></h2><p>Wow, it has been a long episode, but we accomplished a lot:</p><ul><li>We have a web server listening on port 8000. Try this at home:<ol><li>http://localhost:8000/</li><li>http://localhost:8000/show</li><li>http://localhost:8000/store</li></ol></li><li><p>We have marshalling/unmarshalling of our recipes to and from JSON</p></li><li><p>We have json/bson serialisation/deserialisation and we can store our
recipes effortlessly.</p></li></ul><h2 id="external-references"><a href="#external-references">External References</a></h2><p>Refer to the official documentation and Oliver Charles' post:</p><ul><li><p><a href="http://hackage.haskell.org/package/snap">Haddock Documentation for Snap</a></p></li><li><p><a href="http://ocharles.org.uk/blog/posts/2012-12-19-24-days-of-hackage-snap.html">24 days of Hackage: Snap</a></p></li></ul><h2 id="the-code"><a href="#the-code">The code</a></h2><p>Grab the code <a href="https://github.com/cakesolutions/the-pragmatic-haskeller/tree/master/02-snap">here</a>.
The example is self contained, just cabal-install it!</p><h2 id="next-time"><a href="#next-time">Next Time</a></h2><p>We'll mess with config file.
Stay tuned!</p><p>A.</p></article>


</div>
</div>
<div class="row article-footer"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
</div>
<div class="footer"><div class="container"><div class="row"><div class="span12"><ul class="menu"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>

<li><a class="brand" href="https://fpcomplete.com">Sponsored by:
<img src="/static/img/logo.png" title="FPComplete">
</a>
</li>
</ul>
</div>
</div>
<div class="row"><div class="span12"></div>
</div>
</div>
</div>
<link rel="stylesheet" type="text/css" href="/static/bootstrap/css/bootstrap-responsive.css" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://www.schoolofhaskell.com/static/combined/Y-3k9_tW.js"></script><script>$(function(){
  $("a.logout").click(function(){
    var form = $("<form method='post'/>");
    form.attr("action", $(this).attr("href"));
    $("body").append(form);
    form.submit();
    return false;
  });
});

$(function(){
    $('.sociallinksunicode a').each(function(){
        $(this).attr('href',$(this).attr('href').replace('$url$',document.location));
    });
});

$(function(){
  // If we need to select a user/select a password then show the
  // details confirmation form, otherwise enable the getting started
  // section.
  if($('.alert-block a').text().match(/(selected a username|change your password)/)) {
    $("#confirm-details").show();
    $("#confirm-details #inputUsername").focus();
  } else {
    $("#get-started").removeClass('disabled').addClass('enabled');
  }

  // For lack of a plain HTML validation story this will do.
  $('.welcome-page').each(function(){
    $('form').submit(check);
  });
  function check(){
    setTimeout(check,500);
    var error = false;
    $('.error').removeClass('error');
    $('#enter-details input').each(function(){
      if($(this).val() == '') {
        $(this).parent().parent().addClass('error');
        error = true;
      }
    });
    if(error) return false;
    if($('[name=password]').val() == $('[name=confirm]').val()) {
      $('#confirm').removeClass('error');
      return true;
    } else {
      $('#confirm').addClass('error');
      return false;
    }
  }
});

$(function(){
  // When scrolling over a snippet editor, activate the "clone in IDE" popovers
  $('article').each(function(){
    var n = 100;
    var wait = 10000;
    function check(){
      if($('.clone').length == 0) {
        setTimeout(check,n);
        return;
      }
      var activated = $.cookie('clone-popover');
      if (activated) return;
      var activate = false;
      $('.controlsRun:onScreen').each(function(){
        $.cookie('clone-popover', 'true', { expires: 30, path: '/' });
        activate = true;
        return false;
      });
      if(activate) {
          $('.clone').each(function(){
              // The bootstrap API is rather unreasonable to say the
              // least.
              next = $(this).parent();
              var title = next.attr('title');
              next.attr('data-content',$(this).attr('data-content'));
              next.attr('title',$(this).attr('title'));
              next.popover('show',{
                  title: $(this).attr('title')
              });
              next.attr('title',title);
          });
          setTimeout(function(){
              $('.clone').each(function(){
                  $(this).parent().popover('hide');
              });
          },wait);
      } else {
        setTimeout(check,n);
      }
    }
    setTimeout(check,n);
  });
});

// onScreen jQuery plugin v0.2.1
// (c) 2011-2013 Ben Pickles
//
// http://benpickles.github.com/onScreen
//
// Released under MIT license.
(function(a){a.expr[":"].onScreen=function(b){var c=a(window),d=c.scrollTop(),e=c.height(),f=d+e,g=a(b),h=g.offset().top,i=g.height(),j=h+i;return h>=d&&h<f||j>d&&j<=f||i>e&&h<=d&&j>=f}})(jQuery);

/*!
 * jQuery Cookie Plugin v1.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function($, document) {

  var pluses = /\+/g;
  function raw(s) {
    return s;
  }
  function decoded(s) {
    return decodeURIComponent(s.replace(pluses, ' '));
  }

  $.cookie = function(key, value, options) {

    // key and at least value given, set cookie...
    if (arguments.length > 1 && (!/Object/.test(Object.prototype.toString.call(value)) || value == null)) {
      options = $.extend({}, $.cookie.defaults, options);

      if (value == null) {
	options.expires = -1;
      }

      if (typeof options.expires === 'number') {
	var days = options.expires, t = options.expires = new Date();
	t.setDate(t.getDate() + days);
      }

      value = String(value);

      return (document.cookie = [
	encodeURIComponent(key), '=', options.raw ? value : encodeURIComponent(value),
	options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
	options.path    ? '; path=' + options.path : '',
	options.domain  ? '; domain=' + options.domain : '',
	options.secure  ? '; secure' : ''
      ].join(''));
    }

    // key and possibly options given, get cookie...
    options = value || $.cookie.defaults || {};
    var decode = options.raw ? raw : decoded;
    var cookies = document.cookie.split('; ');
    for (var i = 0, parts; (parts = cookies[i] && cookies[i].split('=')); i++) {
      if (decode(parts.shift()) === key) {
	return decode(parts.join('='));
      }
    }
    return null;
  };
  $.cookie.defaults = {};})(jQuery, document);
</script><!--[if lt IE 10]><script src="https://www.schoolofhaskell.com/static/design/js/ie.js?etag=ayV2DuJ0"></script><![endif]--><script>if(!window.location.href.match(/localhost/)){var track = '/tutorial/user/adinapoli/the-pragmatic-haskeller/episode-2-snap';
window._gaq = [['_setAccount','UA-36928035-1'],track != ''? ['_trackPageview',track] : ['_trackPageview']
,['_trackPageLoadTime']];window._gaq.push(['_setCustomVar',1,'Section','School of Haskell',3]);
window._gaq.push(['_setCustomVar',2,'User Type','Visitor',1]);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);

})();}</script>
<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.  chromium.org/developers/how-tos/chrome-frame-getting-started --><!--[if lt IE 7 ]><script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script><script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script><![endif]--></body></html>