<!DOCTYPE html>
<html><head><title>Episode 4 - Recipe Puppy - School of Haskell | School of Haskell</title><meta http-equiv="x-ua-compatible" content="IE=9"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="google-site-verification" content="Rfxk2TdeMMXEXHgJ2_OO8Rt3hPbQSDao0OXQV_n6z_s" /><link href="//fonts.googleapis.com/css?family=Merriweather" rel="stylesheet" type="text/css"><link href="https://www.schoolofhaskell.com/recent-content/feed" type="application/rss+xml" rel="alternate" title="Recently published content">
<link rel="stylesheet" href="https://www.schoolofhaskell.com/static/combined/UlwEHVcM.css"><style>.social{margin-right:1em}h1{font-family:Merriweather !important}article{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}h1,h2,h3,h4,h4,h5{font-family:Merriweather !important}.editor p{font-family:Frutiger, "Frutiger Linotype", Univers, Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans Condensed", "Liberation Sans", "Nimbus Sans L", Tahoma, Geneva, "Helvetica Neue", Helvetica, Arial, sans-serif}.article-footer{border-top:1px solid #ddd;padding-top:1em;margin-top:1em}body{font-size:16px !important}.navbar .navbar-inner{background:#3c3f41}.navbar .brand{font-size:14px}.navbar .brand img{width:6em}.navbar .icon-wrench{margin:0 -0.5em 0 -0.5em;padding:0 1em 0 1em;height:20px}.navbar-inverse .nav .active a{background:#333638}.navbar-inverse .nav > li > a{color:#a7a7a7
}.navbar-inverse .btn-navbar{background:#333638}.navbar-inverse .nav > li a:hover,.navbar-inverse .btn{background:#333537 !important}@media (max-width: 979px) {.icon-wrench{padding-left:1em !important}}.breadcrumb{border-top-left-radius:0;border-top-right-radius:0}h1{margin-top:20px}.breadcrumb-container + .main-content h1{margin-top:0}.footer{padding:30px 0;margin-top:70px;border-top:1px solid #e5e5e5;background-color:#f5f5f5}.footer ul.footer-menu{list-style-type:none}.footer ul.footer-menu li{display:inline-block}.footer ul.footer-menu li + li{margin-left:0.5em}.footer ul.footer-menu li + li:before{margin-right:0.5em;content:"·";color:#999}.footer ul.menu li{display:inline-block}.footer ul.menu li + li{margin-left:0.5em}.footer .copyright{margin-left:25px}.main-content{min-height:100%}.gravatar{width:80px;height:80px;border-radius:2px;background:#eee}.empty-gravatar{width:0}.container{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}.container h1,.container h2,.container h4,.container h4,.container h5{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif}article{font-family:Merriweather !important}article h1{font-family:Merriweather !important}article li{font-family:Merriweather !important;line-height:1.6em}article li + li{margin-top:0.5em}article div.code{background:#f9f9f9;border:1px solid #d1d1d1;position:relative;border-radius:0.2em;margin:0.25em 0 0.75em 0;min-height:2.5em}article code{color:#005580;font-size:14px;white-space:pre}article a.hoogle > code{color:#0088cc;font-size:14px;white-space:pre;border:0}article .expand-code{display:none}article pre{overflow:auto;word-wrap:normal}article code.active{display:block;max-height:430px}article h1{font-size:31.5px}article h3{font-size:17.5px}article h4{font-size:14px}article h5,article h6{font-size:11.9px}article p{line-height:1.7em}article h1 code,article h2 code,article h3 code,article h4 code,article h5 code,article h6 code{font-size:inherit !important}article h1 a,article h2 a,article h3 a,article h4 a,article h5 a,article h6 a{color:#444}article h1 a:before,article h2 a:before,article h3 a:before,article h4 a:before,article h5 a:before,article h6 a:before{margin-left:-1.5em;padding-right:0.5em;font-family:fontawesome;content:"\f0c1";font-size:20px;color:#fff}article h1 a:hover,article h2 a:hover,article h3 a:hover,article h4 a:hover,article h5 a:hover,article h6 a:hover{text-decoration:none;color:#0088cc}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#888}article h2{font-size:24.5px}article .popover{font-family:actor}article .popover h3.popover-title{font-family:actor !important;font-size:1em}article .popover .popover-content{width:15em;font-size:1em}article .controlsRun{display:block;padding:0.5em;text-align:right;background:#f2f2f2}article .controlsRun a.clone{margin-right:1em;font-family:actor;text-decoration:none}article .controlsRun a.clone span{padding-left:0.5em}article .controlsRun a.run,article .controlsRun a.reset,article .controlsRun a.show-code{font-size:16px}article .controlsRun a.run span,article .controlsRun a.reset span,article .controlsRun a.show-code span{display:none}article .controlsRun a.reset{margin-left:0.5em;color:#a2becc}article .controlsRun a.reset{display:none}article .controlsRun a.show-code{margin-right:0.75em}article .controlsRun a.run:hover,article .controlsRun a.show-code:hover{text-decoration:none}article .controlsRun a.show-code.active{color:#DC0D0D}article .controlsRun a[disabled]{color:#a2becc;cursor:default}article .collapse-area .collapse-header{background:#0088cc;color:#fff;padding:0.3em;cursor:pointer}article .collapse-area .hidden-toggle:before{content:"\f0d7";font-family:fontawesome;margin-right:0.5em;margin-left:0.25em}article .collapse-area .collapsed-files{overflow:auto;height:auto}article .collapse-area.collapse-disabled{display:none}article .collapse-area.collapse-area-off .collapsed-files{height:0px;overflow:hidden}article .collapse-area.collapse-area-off .hidden-toggle:before{content:"\f0da"}article .snippet-stdio .stdout{margin:0.5em;padding-right:2em;position:relative;word-wrap:break-word}article .snippet-stdio .stdin{-webkit-box-shadow:none;-moz-box-shadow:none;box-shadow:none;-webkit-transition:none;-moz-transition:none;-o-transition:none;transition:none;padding:0;margin:0}article .hoogle-results{margin:0.25em}article .hoogle-results .hoogle-inner{background:#fff;padding:0.5em;border-radius:3px;border:1px solid #ddd}article .hoogle-results .hoogle-inner .close-link{position:relative;float:right;margin-top:-0.5em;margin-right:-0.5em}article .snippet-output-errors{margin:1em 0.5em 0.5em 0.5em;position:relative}article .snippet-output-errors ul{list-style-type:none;margin:0;position:relative}article .snippet-output-errors pre{border:0;border-radius:0;padding:0.25em;margin:0;background:inherit;color:inherit}article .snippet-output-errors .close-link{color:inherit;background:inherit}article .snippet-editors{z-index:0;padding:0.25em}article .close-link{padding:0.5em;background:#eaeaea;border-bottom-left-radius:0.2em;border-top-right-radius:0.2em;position:absolute;top:0;right:0}article .close-link:hover{text-decoration:none}article .snippet-title{padding:0.5em 0 0 0.5em}article .snippet-title .snippet-icon{font-family:FontAwesome;display:inline-block;margin-right:0.5em}article .fullModuleCode + div .snippet-title{margin-top:0.5em;border-top:1px solid #ccc;padding-top:0.5em}article .CodeMirror{height:auto;min-height:1em;line-height:1.5em;background:transparent;font-size:14px !important}article .CodeMirror .highlighted{background:rgba(250, 210, 0, 0.45) !important}article .CodeMirror-widget{margin-left:2em;line-height:1.8}article .CodeMirror.collapsed{height:10em !important}article .editor .expander{text-align:center;display:block;padding:0.5em;text-decoration:none;border-bottom-left-radius:2px;border-bottom-right-radius:2px}article .editor .expander .ellipsis{background:white;border:1px solid #ccc;padding:0 0.5em;height:1em;line-height:0.5em;display:inline-block;color:#555;cursor:pointer}article .editor .expander .ellipsis:hover{background:#ddd;color:#333}article .web-runner{margin:0.5em;padding:0.5em;border:1px solid #ccc;border-radius:3px;background:#f5f5f5}article .web-runner iframe{border:0;margin-top:0.5em;margin-bottom:0;background:white}article .web-runner .controls i{cursor:pointer;color:#0088cc}article .web-runner .controls i:hover{color:#222}article .web-runner .controls i + i{margin-left:0.5em}article .web-runner .controls .icon-remove{float:right}article .hidden{display:block;visibility:visible}article .controlsShowHide{margin-bottom:0.5em}.tutorial-body{float:left !important}.tutorial-nav{float:right !important}@media (max-width: 979px) {.related-content{float:right}.author-name{display:block;margin-left:20px !important;padding-left:5px;margin-top:5px}article h1 a:hover:before,article h2 a:hover:before,article h3 a:hover:before,article h4 a:hover:before,article h5 a:hover:before,article h6 a:hover:before{color:#fff}.tutorial-nav{float:none !important;width:auto !important}.tutorial-body{float:none !important;width:auto !important}}@media (min-width: 980px) and (max-width: 1199px) {.navbar-search{display:none}.tutorial-nav{width:200px}.tutorial-body{width:720px}}#accountPage h1{margin:20px 0 0 0}#accountPage h2{font-size:20px}.group-contents .span8{float:left}.group-contents .span4{float:right}.container > .alert-block{margin-top:1em}.alert{color:#aa874a
}.social{margin-bottom:.8em;display:block}.social a{text-decoration:none}.social i{font-size:1.1em;color:#fff;padding:0.25em;border-radius:0.25em;width:1em;display:inline-block;text-align:center}.social i.icon-twitter{background:#0088cc}.social i.icon-facebook{background:#3b5998
  }.social i.icon-google-plus{background:#dd4b39
  }.well pre{background:#fcfcfc}.well h2{margin-top:0}code{color:#005580;font-size:14px;white-space:pre}</style><!--[if lt IE 8]><link rel="stylesheet" href="https://www.schoolofhaskell.com/static/design/css/ie7.css?etag=TSMl9x1V"><![endif]--><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head><body class="not-logged-in" itemscope itemtype="http://schema.org/Product"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-H62P" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-H62P');</script><div class="navbar navbar-inverse navbar-static-top"><div class="navbar-inner"><div class="container"><a class="btn btn-navbar" type="button" data-toggle="collapse" data-target=".nav-collapse"><span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</a>
<a class="brand" href="/"><img src="/static/img/haskell-logo-wide.png" title="School of Haskell">
</a>
<div class="nav-collapse collapse"><ul class="nav"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>
</ul>
<form class="navbar-search pull-left" action="https://www.schoolofhaskell.com/search"><input class="search-query" type="text" placeholder="Search" name="search">
</form>
</div>
</div>
</div>
</div>
<div class="container breadcrumb-container"><div class="row"><div class="span12"><ul class="breadcrumb"><li><a href="https://www.schoolofhaskell.com/user/adinapoli">Alfredo Di Napoli</a>
<span class="divider">/</span>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller">The Pragmatic Haskeller</a>
<span class="divider">/</span>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller/episode-4-recipe-puppy">Episode 4 - Recipe Puppy</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container main-content"><div class="row"><div class="span12"><h1 itemprop="name">Episode 4 - Recipe Puppy</h1>
</div>
</div>
<div class="row"><div class="span7 meta"><p><span class="date">28 Apr 2013</span>
<span class="author"><a href="https://www.schoolofhaskell.com/user/adinapoli">Alfredo Di Napoli</a>
</span>
<span class="view-edit-link pull-right"><a class="view-source-link" href="https://www.schoolofhaskell.com/tutorial-raw/2810/f30aa055d9f3455df59c17b7098a6f166fb76622">View Markdown source</a>
</span>
</p>
<p class="tags"></p>
</div>
</div>
<div class="row"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
<p class="alert">As of March 2020, School of Haskell has been switched to read-only mode.</p>
<div class="row" itemprop="desc"><div class="span4 tutorial-nav"><div class="related-content"><ul class="nav nav-tabs nav-stacked"><li><script>reddit_target='fpcomplete'</script>
<script src="https://redditstatic.s3.amazonaws.com/button/button1.js"></script>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller/episode-5-a-simple-dsl">Previous content: Episode 5 - A simple DSL</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller/episode-3-configurator">Next content: Episode 3 - Configurator</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli/the-pragmatic-haskeller">Go up to: The Pragmatic Haskeller</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user/adinapoli">See all content by Alfredo Di Napoli</a>
</li>
</ul>

</div>
<div class="aside"><h3>Sections</h3>
<ul><li><a href="#foreword">Foreword</a></li><li><a href="#speaking-to-the-world">Speaking to the world</a></li><li><a href="#the--hard--way">The &quot;hard&quot; way</a><ul><li><a href="#fred-asks--why-not-use-something-like-http-streams-">Fred asks: Why not use something like http-streams?</a></li></ul></li><li><a href="#http-conduit">http-conduit</a><ul><li><a href="#getting-some-json-from-foursquare">Getting some JSON from Foursquare</a></li></ul></li><li><a href="#calling-recipe-puppy-from-our-webapp">Calling Recipe Puppy from our webapp</a></li><li><a href="#external-references">External References</a></li><li><a href="#the-code">The code</a></li><li><a href="#next-time">Next Time</a></li></ul></div>
</div>
<div class="span8 tutorial-body" data-environment="ghc-7.8-stable-14.09">
<article><h2 id="foreword"><a href="#foreword">Foreword</a></h2><p>This is part of <a href="https://github.com/cakesolutions/the-pragmatic-haskeller">The Pragmatic Haskeller</a> series.</p><h2 id="speaking-to-the-world"><a href="#speaking-to-the-world">Speaking to the world</a></h2><p>Now we have our webapp that can read json from the outside world and store them
inside MongoDB. But during my daily job what I usually need to do is to talk
to some REST service and get, manipulate and store some arbitrary JSON. 
Fortunately for us, Haskell and its rich, high-quality libraries ecosystem
makes the process a breeze.</p><h2 id="the--hard--way"><a href="#the--hard--way">The &quot;hard&quot; way</a></h2><p>Remember what I told you about this series? We have to reason as pragmatic
programmers, choosing the tools which seem more appropriate for the task at
stake. During my initial exploration of the library space, I landed on
<a href="http://hackage.haskell.org/package/HTTP-4000.2.8">HTTP</a>.
It makes the process of making GET requests as simple as:</p><pre><code class="active haskell">module Main where

import Network.HTTP
import Control.Applicative

get :: String -&gt; IO String
get url = do
    response &lt;- simpleHTTP $ getRequest url
    getResponseBody response

main = take 204 &lt;$&gt; get &quot;http://www.alfredodinapoli.com&quot; &gt;&gt;= print</code></pre><p>Alas, <code>HTTP</code> does not support SSL out of the box (a quick glimpse to the
dependency list for this library would be enough):</p><pre><code class="active haskell">module Main where

import Network.HTTP
import Control.Applicative

get :: String -&gt; IO String
get url = do
    response &lt;- simpleHTTP $ getRequest url
    getResponseBody response

-- show
main = take 20 &lt;$&gt; get &quot;https://www.google.it&quot; &gt;&gt;= print
-- /show</code></pre><p>Now, here is where pragmatism comes into play; if you are planning to do just
&quot;plain&quot; http requests and don't need SSL at all, you can stick with <code>HTTP</code> and
live long and happy. In case you have more demanding use case scenarios, you
have two options:</p><ol><li><p>Use an Haskell library like <a href="http://hackage.haskell.org/package/HsOpenSSL">HsOpenSSL</a>
or <a href="http://hackage.haskell.org/package/tls">tsl</a> to integrate <code>HTTP</code> with SSL.</p></li><li><p>Use a library which supports SSL out of the box, like <a href="http://hackage.haskell.org/package/http-conduit">http-conduit</a></p></li></ol><h3 id="fred-asks--why-not-use-something-like-http-streams-"><a href="#fred-asks--why-not-use-something-like-http-streams-">Fred asks: Why not use something like <code>http-streams</code>?</a></h3><p>Answer: even though I'm a big fan of <a href="http://hackage.haskell.org/package/io-streams-1.0.2.1">io-streams</a>
per se, I decided <i>not</i> to use <a href="http://hackage.haskell.org/package/http-streams">http-streams</a>.
It looks very promising, but I've found one little wart: it depends on <code>HsOpenSSL</code>.
This brings two drawbacks on the table:</p><ol><li><p>HsOpenSSL's author &quot;wants to encourage you to use and improve the tls 
package instead as long as possible. The only problem is that the tls 
package has not received as much review as OpenSSL from cryptography 
specialists yet, thus we can't assume it's secure enough.&quot;</p></li><li><p>Using <code>HsOpenSSL</code> makes the process of writing secured http connection a bit
too verbose, in my humble opinion. This is an excerpt from <code>http-streams</code>
documentation:</p></li></ol><pre><code class="haskell">import OpenSSL (withOpenSSL)

main :: IO ()
main = withOpenSSL $ do
    ctx &lt;- baselineContextSSL
    c &lt;- openConnectionSSL ctx &quot;api.github.com&quot; 443
    ...
    closeConnection c</code></pre><p>As we'll see, using <code>http-conduit</code> will make the process a no-brainer. Said that,
don't take my words as a judgment over the library quality. I like it very much
and I hope to see a bit of boilerplate scrapped in the future.</p><h2 id="http-conduit"><a href="#http-conduit">http-conduit</a></h2><p>This library took some design choices for you, using <code>tsl</code> under the hood.
It's extremely easy to use, so easy that I'll include here an extra snippet,
non included in the Github lesson, but that I hope will be useful as a real
world example. After all, I couldn't be in peace of mind publishing an episode
which claims to be some sort of &quot;solution for real world problems&quot; if I was
limiting the scope to GET requests. Hardly in production you'll do just plain
GET requests.</p><h3 id="getting-some-json-from-foursquare"><a href="#getting-some-json-from-foursquare">Getting some JSON from Foursquare</a></h3><p>Imagine the scenario; you need to fetch some JSON from Foursquare (which talks
through SSL) and manipulate this JSON to extract some information. To be honest,
during the <a href="https://www.fpcomplete.com/school/pick-of-the-week/episode-1-json">first episode</a>
I didn't tell you all the truth about <code>aeson</code>.
There are two features which are simply outstanding:</p><ul><li><p>Generic derivation. Using GHC's Generics you can let <code>aeson</code> derive automatically
the marshalling/unmarshalling boilerplate code. Try this at home:</p></li></ul><pre><code class="active haskell">{-# LANGUAGE DeriveGeneric #-}
{-# LANGUAGE OverloadedStrings #-}
module Main where

import Data.Aeson
import qualified Data.ByteString.Lazy.Char8 as BL

import GHC.Generics (Generic)

data Person = Person { name :: String,
                       age  :: Int} deriving (Show, Generic)

instance FromJSON Person
instance ToJSON Person

rawData = BL.pack &quot;{\&quot;name\&quot;: \&quot;John\&quot;, \&quot;age\&quot;: 35}&quot;
main = print $ (decode rawData  :: Maybe Person)</code></pre><p>Pretty impressive, isn't it?</p><ul><li><p>Manipulation of the &quot;raw&quot; AST. As written in <code>aeson</code>'s documentation, 
&quot;sometimes you want to work with JSON data directly, without first converting
it to a custom data type. The Value type, which is an instance of <code>FromJSON</code>,
is used to represent an arbitrary JSON AST (abstract syntax tree).&quot;</p></li></ul><p>We can use this awesome functionality to extract the number of checkins for
a FS' venue, with the following code:</p><pre><code class="active haskell">{-# LANGUAGE OverloadedStrings #-}
module Main where

import Data.Monoid
import Data.Aeson
import Network.HTTP.Conduit

type FsVenueId = String

apiUrl :: String
apiUrl = &quot;https://api.foursquare.com/v2/venues/&quot;

requestUrl :: String
requestUrl = &quot;?oauth_token=&quot; &lt;&gt;
             &quot;FGCUCQ0II3HEFFEZYI24U4FBTAP4AUSDHAJWOUX1FIE5QIY5&quot; &lt;&gt; &quot;&amp;v=&quot; &lt;&gt;
             &quot;20130427&quot;

requestBuilder :: FsVenueId -&gt; String
requestBuilder vid = apiUrl &lt;&gt; vid &lt;&gt; requestUrl


getVenue :: FsVenueId -&gt; IO (Maybe Value)
getVenue vid = do
    rawJson &lt;- simpleHttp $ requestBuilder vid
    return (decode rawJson :: Maybe Value)

main = do
  response &lt;- getVenue &quot;40a55d80f964a52020f31ee3&quot;
  case response of
    (Just v) -&gt; print . take 400 . show $ v
    Nothing  -&gt; print &quot;Failed to fetch venue.&quot;</code></pre><p>Et voilà! Now we have a pretty generic data structure, and the task to write
a simple function to find the field &quot;checkinsCount&quot; inside the <code>Object</code> &quot;stat&quot;
is left as an exercise for the reader. Highlighted you can see how easy it was
to talk to FS using SSL; yes, just a one liner, which the function <a class="hoogle" href="https://www.stackage.org/lts/hoogle?q=simpleHttp" title="Hoogle search for: simpleHttp"><code>simpleHttp</code></a>.</p><h2 id="calling-recipe-puppy-from-our-webapp"><a href="#calling-recipe-puppy-from-our-webapp">Calling Recipe Puppy from our webapp</a></h2><p><a href="http://www.recipepuppy.com/">Recipe Puppy</a> is a nice REST service I've found googling for a web service
with minimal authentication overhead and, of course, cooking-related. Let's
suppose we want to retrive recipes based on one ingredient contained within,
well, it turns out that all it takes is to call this REST link:</p><p><a href="http://www.recipepuppy.com/api?i=garlic">Find recipes which contain onion</a></p><p>All we need, then, is a small wrapper which allows us to call our underlying
web service. We'll be using Recipe Puppy for its simplicity, but at this point
you should know we can make complex calls thanks to <code>HTTP</code> or <code>http-conduit</code>.
The choice I've made was to segregate our routes into a separate file, and
then appending the routes back to the main routes function (inside Site.hs):</p><pre><code class="haskell">{-# LANGUAGE OverloadedStrings #-}

module Pragmatic.Server.RecipePuppy where

import Pragmatic.Server.Application
import Data.ByteString
import Snap hiding (get)
import Data.Monoid
import Data.Text (Text)
import qualified Data.Text as T
import qualified Data.Text.Encoding as T
import qualified Network.HTTP as H

apiUrl :: Text
apiUrl = &quot;http://www.recipepuppy.com/api/&quot;

puppyRoutes :: [(ByteString, AppHandler ())]
puppyRoutes = [(&quot;/puppy/search/:ingredient&quot;, searchByIngredient)]

get :: String -&gt; IO String
get url = do
    response &lt;- H.simpleHTTP $ H.getRequest url
    H.getResponseBody response

searchByIngredient :: AppHandler ()
searchByIngredient = do
    i &lt;- getParam &quot;ingredient&quot;
    let ingredient = maybe &quot;&quot; T.decodeUtf8 i
    output &lt;- liftIO $ get (T.unpack $ apiUrl &lt;&gt; &quot;?i=&quot; &lt;&gt; ingredient)
    writeText (T.pack output)</code></pre><p>Just some comments:</p><ul><li>I used <code>HTTP</code>, but <code>http-conduit</code> would have been a good choice too</li><li>I've used the <a class="hoogle" href="https://www.stackage.org/lts/hoogle?q=maybe" title="Hoogle search for: maybe"><code>maybe</code></a> function to yield an empty string in
case <code>i</code> was <code>Nothing</code>, or applying the function <code>decodeUtf8</code> in case it 
was not.</li></ul><p>Done! Now if we append the <code>puppyRoutes</code> list to the &quot;main&quot; one inside <code>Site.hs</code>,
we can navigate to <a href="http://localhost:8000/puppy/search/garlic">http://localhost:8000/puppy/search/garlic</a>
and see some JSON!</p><h2 id="external-references"><a href="#external-references">External References</a></h2><p>Refer to the official documentations, as always.</p><h2 id="the-code"><a href="#the-code">The code</a></h2><p>Grab the code <a href="https://github.com/cakesolutions/the-pragmatic-haskeller/tree/master/04-recipe-puppy">here</a>.
The example is self contained, just cabal-install it!</p><h2 id="next-time"><a href="#next-time">Next Time</a></h2><p>It's time to build our small DSL for describing recipes!
Stay tuned!</p><p>A.</p></article>


</div>
</div>
<div class="row article-footer"><div class="span7 meta"><span class="sociallinksunicode social">
<a href="https://twitter.com/home?status=$url$" target="_blank"><i class="icon-twitter"></i></a>&nbsp;
<a href="http://www.facebook.com/sharer/sharer.php?u=$url$" target="_blank"><i class="icon-facebook"></i></a>&nbsp;
<a href="https://plus.google.com/share?url=$url$" target="_blank"><i class="icon-google-plus"></i></a></span>
</div>
</div>
</div>
<div class="footer"><div class="container"><div class="row"><div class="span12"><ul class="menu"><li><a href="https://www.schoolofhaskell.com/">School</a>
</li>
<li><a href="https://www.schoolofhaskell.com/user">Users</a>
</li>

<li><a class="brand" href="https://fpcomplete.com">Sponsored by:
<img src="/static/img/logo.png" title="FPComplete">
</a>
</li>
</ul>
</div>
</div>
<div class="row"><div class="span12"></div>
</div>
</div>
</div>
<link rel="stylesheet" type="text/css" href="/static/bootstrap/css/bootstrap-responsive.css" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://www.schoolofhaskell.com/static/combined/Y-3k9_tW.js"></script><script>$(function(){
  $("a.logout").click(function(){
    var form = $("<form method='post'/>");
    form.attr("action", $(this).attr("href"));
    $("body").append(form);
    form.submit();
    return false;
  });
});

$(function(){
    $('.sociallinksunicode a').each(function(){
        $(this).attr('href',$(this).attr('href').replace('$url$',document.location));
    });
});

$(function(){
  // If we need to select a user/select a password then show the
  // details confirmation form, otherwise enable the getting started
  // section.
  if($('.alert-block a').text().match(/(selected a username|change your password)/)) {
    $("#confirm-details").show();
    $("#confirm-details #inputUsername").focus();
  } else {
    $("#get-started").removeClass('disabled').addClass('enabled');
  }

  // For lack of a plain HTML validation story this will do.
  $('.welcome-page').each(function(){
    $('form').submit(check);
  });
  function check(){
    setTimeout(check,500);
    var error = false;
    $('.error').removeClass('error');
    $('#enter-details input').each(function(){
      if($(this).val() == '') {
        $(this).parent().parent().addClass('error');
        error = true;
      }
    });
    if(error) return false;
    if($('[name=password]').val() == $('[name=confirm]').val()) {
      $('#confirm').removeClass('error');
      return true;
    } else {
      $('#confirm').addClass('error');
      return false;
    }
  }
});

$(function(){
  // When scrolling over a snippet editor, activate the "clone in IDE" popovers
  $('article').each(function(){
    var n = 100;
    var wait = 10000;
    function check(){
      if($('.clone').length == 0) {
        setTimeout(check,n);
        return;
      }
      var activated = $.cookie('clone-popover');
      if (activated) return;
      var activate = false;
      $('.controlsRun:onScreen').each(function(){
        $.cookie('clone-popover', 'true', { expires: 30, path: '/' });
        activate = true;
        return false;
      });
      if(activate) {
          $('.clone').each(function(){
              // The bootstrap API is rather unreasonable to say the
              // least.
              next = $(this).parent();
              var title = next.attr('title');
              next.attr('data-content',$(this).attr('data-content'));
              next.attr('title',$(this).attr('title'));
              next.popover('show',{
                  title: $(this).attr('title')
              });
              next.attr('title',title);
          });
          setTimeout(function(){
              $('.clone').each(function(){
                  $(this).parent().popover('hide');
              });
          },wait);
      } else {
        setTimeout(check,n);
      }
    }
    setTimeout(check,n);
  });
});

// onScreen jQuery plugin v0.2.1
// (c) 2011-2013 Ben Pickles
//
// http://benpickles.github.com/onScreen
//
// Released under MIT license.
(function(a){a.expr[":"].onScreen=function(b){var c=a(window),d=c.scrollTop(),e=c.height(),f=d+e,g=a(b),h=g.offset().top,i=g.height(),j=h+i;return h>=d&&h<f||j>d&&j<=f||i>e&&h<=d&&j>=f}})(jQuery);

/*!
 * jQuery Cookie Plugin v1.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function($, document) {

  var pluses = /\+/g;
  function raw(s) {
    return s;
  }
  function decoded(s) {
    return decodeURIComponent(s.replace(pluses, ' '));
  }

  $.cookie = function(key, value, options) {

    // key and at least value given, set cookie...
    if (arguments.length > 1 && (!/Object/.test(Object.prototype.toString.call(value)) || value == null)) {
      options = $.extend({}, $.cookie.defaults, options);

      if (value == null) {
	options.expires = -1;
      }

      if (typeof options.expires === 'number') {
	var days = options.expires, t = options.expires = new Date();
	t.setDate(t.getDate() + days);
      }

      value = String(value);

      return (document.cookie = [
	encodeURIComponent(key), '=', options.raw ? value : encodeURIComponent(value),
	options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
	options.path    ? '; path=' + options.path : '',
	options.domain  ? '; domain=' + options.domain : '',
	options.secure  ? '; secure' : ''
      ].join(''));
    }

    // key and possibly options given, get cookie...
    options = value || $.cookie.defaults || {};
    var decode = options.raw ? raw : decoded;
    var cookies = document.cookie.split('; ');
    for (var i = 0, parts; (parts = cookies[i] && cookies[i].split('=')); i++) {
      if (decode(parts.shift()) === key) {
	return decode(parts.join('='));
      }
    }
    return null;
  };
  $.cookie.defaults = {};})(jQuery, document);
</script><!--[if lt IE 10]><script src="https://www.schoolofhaskell.com/static/design/js/ie.js?etag=ayV2DuJ0"></script><![endif]--><script>if(!window.location.href.match(/localhost/)){var track = '/tutorial/user/adinapoli/the-pragmatic-haskeller/episode-4-recipe-puppy';
window._gaq = [['_setAccount','UA-36928035-1'],track != ''? ['_trackPageview',track] : ['_trackPageview']
,['_trackPageLoadTime']];window._gaq.push(['_setCustomVar',1,'Section','School of Haskell',3]);
window._gaq.push(['_setCustomVar',2,'User Type','Visitor',1]);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);

})();}</script>
<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.  chromium.org/developers/how-tos/chrome-frame-getting-started --><!--[if lt IE 7 ]><script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script><script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script><![endif]--></body></html>